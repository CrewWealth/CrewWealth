<!DOCTYPE html>
<html lang="en">
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget - CrewWealth</title>
    <style>
        :root {
            --color-primary: #208089;
            --color-primary-hover: #1a6670;
            --color-primary-active: #1a5460;
            --color-secondary: #5e5240;
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-border: #e8e8e0;
            --color-success: #22c55e;
            --color-warning: #f59e61;
            --color-danger: #ef4444;
            --color-accent: #32b8c6;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* LEFT SIDEBAR - ACCOUNTS */
        .accounts-sidebar {
            width: 220px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            color: var(--color-text);
            cursor: pointer;
            transition: color 0.2s;
        }

        .sidebar-title:hover {
            color: var(--color-primary);
        }

        .account-section {
            margin-bottom: var(--spacing-xl);
        }

        .account-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-secondary);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .account-item:hover {
            background: rgba(32, 128, 137, 0.08);
        }

        .account-item.active {
            background: var(--color-primary);
            color: white;
        }

        .account-name {
            font-weight: 500;
            flex: 1;
        }

        .account-balance {
            font-weight: 600;
            font-size: 12px;
        }

        .account-delete {
            margin-left: var(--spacing-sm);
            color: var(--color-danger);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
        }

        .account-item:hover .account-delete {
            opacity: 1;
        }

        .add-account-btn {
            width: 100%;
            padding: var(--spacing-sm);
            background: transparent;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: var(--spacing-md);
        }

        .add-account-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* TOP BAR */
        .top-bar {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--spacing-lg) var(--spacing-2xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .back-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(32, 128, 137, 0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: rgba(32, 128, 137, 0.2);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .month-btn {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .month-btn:hover {
            background: rgba(32, 128, 137, 0.1);
        }

        .current-month {
            font-size: 16px;
            font-weight: 600;
            min-width: 150px;
            text-align: center;
        }

        /* BUDGET OVERVIEW CARD */
        .budget-overview {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-2xl);
            margin: var(--spacing-xl) var(--spacing-2xl) 0;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .overview-item {
            text-align: center;
        }

        .overview-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: var(--spacing-xs);
        }

        .overview-value {
            font-size: 20px;
            font-weight: 700;
        }

        .to-budget {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .to-budget-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: var(--spacing-xs);
        }

        .to-budget-value {
            font-size: 36px;
            font-weight: 700;
        }

        /* CATEGORIES SECTION */
        .categories-section {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-xl) var(--spacing-2xl);
        }

        .category-group {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }

        .category-group-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(32, 128, 137, 0.05);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .category-group-header:hover {
            background: rgba(32, 128, 137, 0.08);
        }

        .category-group-name {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text);
        }

        .category-group-totals {
            display: flex;
            gap: var(--spacing-xl);
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .category-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 40px;
            gap: var(--spacing-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--color-border);
            align-items: center;
        }

        .category-row:hover {
            background: rgba(32, 128, 137, 0.03);
        }

        .category-name {
            font-size: 14px;
            font-weight: 500;
        }

        .category-value {
            font-size: 14px;
            font-weight: 600;
            text-align: right;
        }

        .category-value.positive {
            color: var(--color-success);
        }

        .category-value.negative {
            color: var(--color-danger);
        }

        .budget-input {
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            text-align: right;
            font-weight: 600;
            background: var(--color-surface);
        }

        .budget-input:focus {
            outline: none;
            border-color: var(--color-primary);
            background: rgba(32, 128, 137, 0.05);
        }

        .category-delete {
            color: var(--color-danger);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
            text-align: center;
        }

        .category-row:hover .category-delete {
            opacity: 1;
        }

        /* ADD CATEGORY BUTTON */
        .add-category-btn {
            width: 100%;
            padding: var(--spacing-md);
            background: transparent;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            font-size: 13px;
            cursor: pointer;
            margin-bottom: var(--spacing-lg);
            transition: all 0.2s;
        }

        .add-category-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        /* TRANSACTIONS VIEW */
        .transactions-view {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
        }

        .transactions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .transactions-title {
            font-size: 20px;
            font-weight: 700;
        }

        .add-transaction-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .add-transaction-btn:hover {
            background: var(--color-primary-hover);
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .transactions-table th {
            text-align: left;
            padding: var(--spacing-md);
            background: rgba(32, 128, 137, 0.05);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-secondary);
            font-weight: 600;
        }

        .transactions-table td {
            padding: var(--spacing-md);
            border-top: 1px solid var(--color-border);
        }

        .transactions-table tr:hover {
            background: rgba(32, 128, 137, 0.03);
        }

        .transaction-amount {
            font-weight: 600;
        }

        .transaction-amount.inflow {
            color: var(--color-success);
        }

        .transaction-amount.outflow {
            color: var(--color-danger);
        }

        .transaction-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .action-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: scale(1.2);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--color-text-secondary);
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text);
        }

        .form-input, .form-select {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .btn {
            flex: 1;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: rgba(94, 82, 64, 0.1);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.2);
        }

        @media (max-width: 1024px) {
            .accounts-sidebar {
                display: none;
            }
            
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .category-row {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .category-value {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- LEFT SIDEBAR: ACCOUNTS -->
        <aside class="accounts-sidebar">
            <div class="sidebar-title" onclick="window.location.href='/'">üí∞ CrewWealth</div>

            <div class="account-section">
                <div class="account-section-header">
                    <span>All accounts</span>
                    <span id="allAccountsTotal">‚Ç¨0.00</span>
                </div>
            </div>

            <div class="account-section">
                <div class="account-section-header">
                    <span>On budget</span>
                    <span id="onBudgetTotal">‚Ç¨0.00</span>
                </div>
                <div id="onBudgetAccounts"></div>
            </div>

            <div class="account-section">
                <div class="account-section-header">
                    <span>Off budget</span>
                    <span id="offBudgetTotal">‚Ç¨0.00</span>
                </div>
                <div id="offBudgetAccounts"></div>
            </div>

            <button class="add-account-btn" onclick="openAddAccountModal()">+ Add account</button>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- TOP BAR -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <a href="/" class="back-btn">‚Üê Dashboard</a>
                    <h1 class="page-title">Budget</h1>
                </div>
                <div class="month-selector">
                    <button class="month-btn" onclick="changeMonth(-1)">‚óÄ</button>
                    <div class="current-month" id="currentMonth">January 2026</div>
                    <button class="month-btn" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
            </div>

            <!-- BUDGET OVERVIEW CARD -->
            <div class="budget-overview">
                <div class="overview-grid">
                    <div class="overview-item">
                        <div class="overview-label">Available funds</div>
                        <div class="overview-value" id="availableFunds">‚Ç¨0.00</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Overspent</div>
                        <div class="overview-value" id="overspent">‚Ç¨0.00</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Budgeted</div>
                        <div class="overview-value" id="budgeted">‚Ç¨0.00</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Total spent</div>
                        <div class="overview-value" id="totalSpent">‚Ç¨0.00</div>
                    </div>
                </div>
                <div class="to-budget">
                    <div class="to-budget-label">To Budget</div>
                    <div class="to-budget-value" id="toBudget">‚Ç¨0.00</div>
                </div>
            </div>

            <!-- CATEGORIES SECTION -->
            <div class="categories-section" id="categoriesView">
                <div id="categoriesContainer"></div>
                <button class="add-category-btn" onclick="openAddCategoryModal()">+ Add category</button>
            </div>

            <!-- TRANSACTIONS VIEW (Hidden by default) -->
            <div class="categories-section" id="transactionsView" style="display: none;">
                <div class="transactions-view">
                    <div class="transactions-header">
                        <div>
                            <button class="btn-secondary" style="padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-sm);" onclick="showCategoriesView()">‚Üê Back to Budget</button>
                            <h2 class="transactions-title" id="transactionsAccountName">Account Transactions</h2>
                        </div>
                        <button class="add-transaction-btn" onclick="openAddTransactionModal()">+ Add Transaction</button>
                    </div>
                    <table class="transactions-table" id="transactionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Payee</th>
                                <th>Category</th>
                                <th>Memo</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                        </tbody>
                    </table>
                    <div id="emptyTransactions" class="empty-state" style="display: none;">
                        <p>No transactions yet. Add your first transaction to get started!</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ADD ACCOUNT MODAL -->
    <div class="modal" id="addAccountModal">
        <div class="modal-content">
            <div class="modal-header">Add Account</div>
            <form onsubmit="saveAccount(event)">
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" id="accountName" placeholder="e.g., Checking Account" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Starting Balance (‚Ç¨)</label>
                    <input type="number" class="form-input" id="accountBalance" step="0.01" value="0.00" required>
                </div>
                <div class="form-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="accountOffBudget">
                        <span>Off Budget (Investments/Savings)</span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addAccountModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD CATEGORY MODAL -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">Add Category</div>
            <form onsubmit="saveCategory(event)">
                <div class="form-group">
                    <label class="form-label">Category Group</label>
                    <select class="form-select" id="categoryGroup" required>
                        <option value="expenses">üí∏ Daily Expenses</option>
                        <option value="savings">üí∞ Savings Goals</option>
                        <option value="bills">üìÑ Monthly Bills</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category Name</label>
                    <input type="text" class="form-input" id="categoryName" placeholder="e.g., Groceries" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCategoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD/EDIT TRANSACTION MODAL -->
    <div class="modal" id="addTransactionModal">
        <div class="modal-content">
            <div class="modal-header" id="transactionModalTitle">Add Transaction</div>
            <form onsubmit="saveTransaction(event)">
                <input type="hidden" id="transactionId">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="transactionDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Payee</label>
                    <input type="text" class="form-input" id="transactionPayee" placeholder="e.g., Supermarket" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="transactionCategory" required>
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (‚Ç¨)</label>
                    <input type="number" class="form-input" id="transactionAmount" step="0.01" placeholder="Negative for outflow, positive for inflow" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Memo (optional)</label>
                    <input type="text" class="form-input" id="transactionMemo" placeholder="Optional note">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTransactionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyBJws39S0tr3SiFV15Ij8Za1VvVKihWetI",
    authDomain: "crewwealth-cbe02.firebaseapp.com",
    projectId: "crewwealth-cbe02",
    storageBucket: "crewwealth-cbe02.firebasestorage.app",
    messagingSenderId: "522907048863",
    appId: "1:522907048863:web:d0b4b6ea4f1f8a7f3e8e8e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let currentUser = null;

window.addEventListener('load', async () => {
    // Use REAL Firebase UID
    currentUser = { uid: 'HJgW9zvAtkXQOBdYRax0JbnL9Lx1' };
    await init();
});




        // DATA STRUCTURE
        let accounts = [];
        let categories = [];
        let budgets = {}; // { "2026-01": { "cat1": 100.00 } }
        let transactions = [];
        let currentDate = new Date();
        let currentAccountId = null;

        // INITIALIZE
        async function init() {
    await loadData();
            loadData();
            renderAccounts();
            renderCategories();
            updateOverview();
            updateMonthDisplay();
            setDefaultTransactionDate();
        }

        // LOAD DATA FROM LOCALSTORAGE
async function loadData() {
    if (!currentUser) return;
    
    // Load accounts
    const accountsSnap = await db.collection('users').doc(currentUser.uid).collection('accounts').get();
    accounts = accountsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Load categories
    const categoriesSnap = await db.collection('users').doc(currentUser.uid).collection('categories').get();
    categories = categoriesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Load budgets
    const budgetsSnap = await db.collection('users').doc(currentUser.uid).collection('budgets').get();
    budgets = {};
    budgetsSnap.docs.forEach(doc => {
        budgets[doc.id] = doc.data();
    });
    
    // Load transactions
    const transactionsSnap = await db.collection('users').doc(currentUser.uid).collection('transactions').get();
    transactions = transactionsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}

        // SAVE DATA
async function saveAccounts() {
    // Accounts are saved individually, not as array
    // This function is kept for compatibility
}

        function saveCategories() {
            localStorage.setItem('crewwealth_categories', JSON.stringify(categories));
        }

        function saveBudgets() {
            localStorage.setItem('crewwealth_budgets', JSON.stringify(budgets));
        }

        function saveTransactions() {
            localStorage.setItem('crewwealth_transactions', JSON.stringify(transactions));
        }

        // RENDER ACCOUNTS
        function renderAccounts() {
            const onBudgetContainer = document.getElementById('onBudgetAccounts');
            const offBudgetContainer = document.getElementById('offBudgetAccounts');

            onBudgetContainer.innerHTML = '';
            offBudgetContainer.innerHTML = '';

            let allTotal = 0;
            let onBudgetTotal = 0;
            let offBudgetTotal = 0;

            accounts.forEach(acc => {
                const div = document.createElement('div');
                div.className = 'account-item' + (currentAccountId === acc.id ? ' active' : '');
                div.innerHTML = `
                    <span class="account-name">${acc.name}</span>
                    <span class="account-balance">‚Ç¨${acc.balance.toFixed(2)}</span>
                    <span class="account-delete" onclick="deleteAccount('${acc.id}', event)">üóëÔ∏è</span>
                `;
                div.onclick = (e) => {
                    if (!e.target.classList.contains('account-delete')) {
                        viewAccountTransactions(acc.id);
                    }
                };

                allTotal += acc.balance;

                if (acc.offBudget) {
                    offBudgetTotal += acc.balance;
                    offBudgetContainer.appendChild(div);
                } else {
                    onBudgetTotal += acc.balance;
                    onBudgetContainer.appendChild(div);
                }
            });

            document.getElementById('allAccountsTotal').textContent = `‚Ç¨${allTotal.toFixed(2)}`;
            document.getElementById('onBudgetTotal').textContent = `‚Ç¨${onBudgetTotal.toFixed(2)}`;
            document.getElementById('offBudgetTotal').textContent = `‚Ç¨${offBudgetTotal.toFixed(2)}`;
        }

        // DELETE ACCOUNT
        function deleteAccount(accountId, event) {
            event.stopPropagation();
            if (confirm('Are you sure you want to delete this account? All transactions will be removed.')) {
                accounts = accounts.filter(a => a.id !== accountId);
                transactions = transactions.filter(t => t.accountId !== accountId);
                saveAccounts();
                saveTransactions();
                if (currentAccountId === accountId) {
                    showCategoriesView();
                }
                renderAccounts();
                renderCategories();
                updateOverview();
            }
        }

        // VIEW ACCOUNT TRANSACTIONS
        function viewAccountTransactions(accountId) {
            currentAccountId = accountId;
            const account = accounts.find(a => a.id === accountId);
            
            document.getElementById('categoriesView').style.display = 'none';
            document.getElementById('transactionsView').style.display = 'block';
            document.getElementById('transactionsAccountName').textContent = account.name;
            
            renderTransactions();
            renderAccounts(); // Update active state
        }

        // SHOW CATEGORIES VIEW
        function showCategoriesView() {
            currentAccountId = null;
            document.getElementById('categoriesView').style.display = 'block';
            document.getElementById('transactionsView').style.display = 'none';
            renderAccounts(); // Update active state
        }

        // RENDER TRANSACTIONS
        function renderTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            const emptyState = document.getElementById('emptyTransactions');
            tbody.innerHTML = '';

            const accountTransactions = transactions
                .filter(t => t.accountId === currentAccountId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (accountTransactions.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            accountTransactions.forEach(transaction => {
                const category = categories.find(c => c.id === transaction.categoryId);
                const row = document.createElement('tr');
                const amountClass = transaction.amount >= 0 ? 'inflow' : 'outflow';
                
                row.innerHTML = `
                    <td>${new Date(transaction.date).toLocaleDateString('nl-NL')}</td>
                    <td>${transaction.payee}</td>
                    <td>${category ? category.name : 'Uncategorized'}</td>
                    <td>${transaction.memo || '-'}</td>
                    <td class="transaction-amount ${amountClass}">‚Ç¨${Math.abs(transaction.amount).toFixed(2)}</td>
                    <td class="transaction-actions">
                        <button class="action-btn" onclick="editTransaction('${transaction.id}')">‚úèÔ∏è</button>
                        <button class="action-btn" onclick="deleteTransaction('${transaction.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // RENDER CATEGORIES
        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            const monthKey = getMonthKey();
            const monthBudgets = budgets[monthKey] || {};

            const groups = {
                'expenses': { name: 'üí∏ Daily Expenses', items: [] },
                'bills': { name: 'üìÑ Monthly Bills', items: [] },
                'savings': { name: 'üí∞ Savings Goals', items: [] }
            };

            categories.forEach(cat => {
                if (groups[cat.group]) {
                    const budgeted = monthBudgets[cat.id] || 0;
                    const spent = calculateCategorySpent(cat.id, monthKey);
                    groups[cat.group].items.push({ ...cat, budgeted, spent });
                }
            });

            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                if (group.items.length === 0) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'category-group';

                const groupBudgeted = group.items.reduce((sum, cat) => sum + cat.budgeted, 0);
                const groupSpent = group.items.reduce((sum, cat) => sum + cat.spent, 0);
                const groupBalance = groupBudgeted + groupSpent;

                groupDiv.innerHTML = `
                    <div class="category-group-header">
                        <span class="category-group-name">${group.name}</span>
                        <div class="category-group-totals">
                            <span>Budgeted: ‚Ç¨${groupBudgeted.toFixed(2)}</span>
                            <span>Spent: ‚Ç¨${groupSpent.toFixed(2)}</span>
                            <span>Balance: ‚Ç¨${groupBalance.toFixed(2)}</span>
                        </div>
                    </div>
                `;

                group.items.forEach(cat => {
                    const balance = cat.budgeted + cat.spent;
                    const balanceClass = balance >= 0 ? 'positive' : 'negative';

                    const row = document.createElement('div');
                    row.className = 'category-row';
                    row.innerHTML = `
                        <div class="category-name">${cat.name}</div>
                        <input type="number" class="budget-input" value="${cat.budgeted.toFixed(2)}" 
                               onchange="updateBudget('${cat.id}', this.value)" step="0.01">
                        <div class="category-value">‚Ç¨${cat.spent.toFixed(2)}</div>
                        <div class="category-value ${balanceClass}">‚Ç¨${balance.toFixed(2)}</div>
                        <div class="category-delete" onclick="deleteCategory('${cat.id}')">üóëÔ∏è</div>
                    `;
                    groupDiv.appendChild(row);
                });

                container.appendChild(groupDiv);
            });
        }

        // CALCULATE CATEGORY SPENT
        function calculateCategorySpent(categoryId, monthKey) {
            const [year, month] = monthKey.split('-').map(Number);
            return transactions
                .filter(t => {
                    const tDate = new Date(t.date);
                    return t.categoryId === categoryId && 
                           tDate.getFullYear() === year && 
                           tDate.getMonth() === month - 1;
                })
                .reduce((sum, t) => sum + t.amount, 0);
        }

        // UPDATE BUDGET
        function updateBudget(categoryId, value) {
            const monthKey = getMonthKey();
            if (!budgets[monthKey]) {
                budgets[monthKey] = {};
            }
            budgets[monthKey][categoryId] = parseFloat(value) || 0;
            saveBudgets();
            renderCategories();
            updateOverview();
        }

        // DELETE CATEGORY
        function deleteCategory(categoryId) {
            if (confirm('Are you sure you want to delete this category?')) {
                categories = categories.filter(c => c.id !== categoryId);
                saveCategories();
                renderCategories();
                updateOverview();
            }
        }

        // UPDATE OVERVIEW
        function updateOverview() {
            const onBudgetBalance = accounts.filter(a => !a.offBudget).reduce((sum, a) => sum + a.balance, 0);
            
            const monthKey = getMonthKey();
            const monthBudgets = budgets[monthKey] || {};
            const totalBudgeted = Object.values(monthBudgets).reduce((sum, b) => sum + b, 0);
            
            let totalSpent = 0;
            categories.forEach(cat => {
                totalSpent += calculateCategorySpent(cat.id, monthKey);
            });

            const overspent = Math.min(0, totalBudgeted + totalSpent);
            const toBudget = onBudgetBalance - totalBudgeted;

            document.getElementById('availableFunds').textContent = `‚Ç¨${onBudgetBalance.toFixed(2)}`;
            document.getElementById('budgeted').textContent = `‚Ç¨${totalBudgeted.toFixed(2)}`;
            document.getElementById('totalSpent').textContent = `‚Ç¨${Math.abs(totalSpent).toFixed(2)}`;
            document.getElementById('overspent').textContent = `‚Ç¨${Math.abs(overspent).toFixed(2)}`;
            document.getElementById('toBudget').textContent = `‚Ç¨${toBudget.toFixed(2)}`;
        }

        // MONTH NAVIGATION
        function getMonthKey() {
            return `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        }

        function updateMonthDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const monthStr = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            document.getElementById('currentMonth').textContent = monthStr;
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            updateMonthDisplay();
            renderCategories();
            updateOverview();
        }

        // MODAL FUNCTIONS
        function openAddAccountModal() {
            document.getElementById('addAccountModal').classList.add('active');
        }

        function openAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.add('active');
        }

        function openAddTransactionModal() {
            document.getElementById('transactionModalTitle').textContent = 'Add Transaction';
            document.getElementById('transactionId').value = '';
            document.getElementById('addTransactionModal').classList.add('active');
            populateCategoryDropdown();
            setDefaultTransactionDate();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'addTransactionModal') {
                document.getElementById('transactionId').value = '';
                document.querySelector(`#${modalId} form`).reset();
            }
        }

        // POPULATE CATEGORY DROPDOWN
        function populateCategoryDropdown() {
            const select = document.getElementById('transactionCategory');
            select.innerHTML = '<option value="">Select category...</option>';
            
            const groups = {
                'expenses': 'üí∏ Daily Expenses',
                'bills': 'üìÑ Monthly Bills',
                'savings': 'üí∞ Savings Goals'
            };

            Object.keys(groups).forEach(groupKey => {
                const groupCats = categories.filter(c => c.group === groupKey);
                if (groupCats.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = groups[groupKey];
                    groupCats.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                }
            });
        }

        // SET DEFAULT TRANSACTION DATE
        function setDefaultTransactionDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
        }

        // SAVE ACCOUNT
        async function saveAccount(event) {
    event.preventDefault();
    
    const name = document.getElementById('accountName').value;
    const balance = parseFloat(document.getElementById('accountBalance').value);
    const offBudget = document.getElementById('accountOffBudget').checked;
    
    try {
        await db.collection('users').doc(currentUser.uid).collection('accounts').add({
            name: name,
            balance: balance,
            offBudget: offBudget,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeModal('addAccountModal');
        await loadData();
        renderAccounts();
        updateOverview();
        
        // Reset form
        document.getElementById('accountName').value = '';
        document.getElementById('accountBalance').value = '0.00';
        document.getElementById('accountOffBudget').checked = false;
    } catch (error) {
        console.error('Error saving account:', error);
        alert('Failed to save account. Please try again.');
    }
}


        // SAVE CATEGORY
        function saveCategory(event) {
            event.preventDefault();
            const group = document.getElementById('categoryGroup').value;
            const name = document.getElementById('categoryName').value;

            const newCategory = {
                id: 'cat_' + Date.now(),
                group,
                name
            };

            categories.push(newCategory);
            saveCategories();
            renderCategories();
            updateOverview();
            closeModal('addCategoryModal');
            event.target.reset();
        }

        // SAVE TRANSACTION
        function saveTransaction(event) {
            event.preventDefault();
            const id = document.getElementById('transactionId').value;
            const date = document.getElementById('transactionDate').value;
            const payee = document.getElementById('transactionPayee').value;
            const categoryId = document.getElementById('transactionCategory').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value) || 0;
            const memo = document.getElementById('transactionMemo').value;

            if (id) {
                // Edit existing
                const transaction = transactions.find(t => t.id === id);
                const oldAmount = transaction.amount;
                const oldAccountId = transaction.accountId;
                
                transaction.date = date;
                transaction.payee = payee;
                transaction.categoryId = categoryId;
                transaction.amount = amount;
                transaction.memo = memo;

                // Update account balance
                const account = accounts.find(a => a.id === oldAccountId);
                account.balance = account.balance - oldAmount + amount;
            } else {
                // Add new
                const newTransaction = {
                    id: 'txn_' + Date.now(),
                    accountId: currentAccountId,
                    date,
                    payee,
                    categoryId,
                    amount,
                    memo
                };
                transactions.push(newTransaction);

                // Update account balance
                const account = accounts.find(a => a.id === currentAccountId);
                account.balance += amount;
            }

            saveTransactions();
            saveAccounts();
            renderTransactions();
            renderAccounts();
            renderCategories();
            updateOverview();
            closeModal('addTransactionModal');
            event.target.reset();
        }

        // EDIT TRANSACTION
        function editTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            
            document.getElementById('transactionModalTitle').textContent = 'Edit Transaction';
            document.getElementById('transactionId').value = transaction.id;
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('transactionPayee').value = transaction.payee;
            document.getElementById('transactionCategory').value = transaction.categoryId;
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionMemo').value = transaction.memo;
            
            openAddTransactionModal();
        }

        // DELETE TRANSACTION
        function deleteTransaction(transactionId) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                const transaction = transactions.find(t => t.id === transactionId);
                const account = accounts.find(a => a.id === transaction.accountId);
                
                // Reverse the transaction from account balance
                account.balance -= transaction.amount;
                
                transactions = transactions.filter(t => t.id !== transactionId);
                saveTransactions();
                saveAccounts();
                renderTransactions();
                renderAccounts();
                renderCategories();
                updateOverview();
            }
        }

        // Click outside modal to close
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // INIT ON LOAD
        init();
    </script>
</body>
</html>
