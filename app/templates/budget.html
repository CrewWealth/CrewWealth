<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget - CrewWealth</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --color-primary: #208089;
            --color-primary-hover: #1a6670;
            --color-primary-active: #1a5460;
            --color-secondary: #5e5240;
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-border: #e8e8e0;
            --color-success: #22c55e;
            --color-warning: #f59e61;
            --color-danger: #ef4444;
            --color-accent: #32b8c6;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .accounts-sidebar {
            width: 220px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            color: var(--color-text);
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
            display: block;
        }

        .sidebar-title:hover {
            color: var(--color-primary);
        }

        .account-section {
            margin-bottom: var(--spacing-xl);
        }

        .account-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-secondary);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: background 0.2s;
        }

        .account-section-header:hover {
            background: rgba(32, 128, 137, 0.05);
        }

        .account-section-header.active {
            background: rgba(32, 128, 137, 0.1);
            color: var(--color-primary);
            font-weight: 700;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .account-item:hover {
            background: rgba(32, 128, 137, 0.08);
        }

        .account-item.active {
            background: var(--color-primary);
            color: white;
        }

        .account-item.active .account-balance {
            color: white;
        }

        .account-name {
            font-weight: 500;
            flex: 1;
        }

        .account-balance {
            font-weight: 600;
            font-size: 12px;
        }

        .account-delete {
            margin-left: var(--spacing-sm);
            color: var(--color-danger);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
        }

        .account-item:hover .account-delete {
            opacity: 1;
        }

        .add-account-btn {
            width: 100%;
            padding: var(--spacing-sm);
            background: transparent;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-account-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--spacing-lg) var(--spacing-2xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .back-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(32, 128, 137, 0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: rgba(32, 128, 137, 0.2);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .month-btn {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .month-btn:hover {
            background: rgba(32, 128, 137, 0.1);
        }

        .current-month {
            font-size: 16px;
            font-weight: 600;
            min-width: 150px;
            text-align: center;
        }

        /* Budget Overview */
        .budget-overview {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-2xl);
            margin: var(--spacing-xl) var(--spacing-2xl) 0;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .overview-item {
            text-align: center;
        }

        .overview-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: var(--spacing-xs);
        }

        .overview-value {
            font-size: 20px;
            font-weight: 700;
        }

        .to-budget {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .to-budget-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: var(--spacing-xs);
        }

        .to-budget-value {
            font-size: 36px;
            font-weight: 700;
        }

        /* Categories Section */
        .categories-section {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-xl) var(--spacing-2xl);
        }

        .category-group {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }

        .category-group-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(32, 128, 137, 0.05);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .category-group-header:hover {
            background: rgba(32, 128, 137, 0.08);
        }

        .category-group-name {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text);
        }

        .category-group-totals {
            display: flex;
            gap: var(--spacing-xl);
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .category-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 40px;
            gap: var(--spacing-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--color-border);
            align-items: center;
        }

        .category-row:hover {
            background: rgba(32, 128, 137, 0.03);
        }

        .category-name {
            font-size: 14px;
            font-weight: 500;
        }

        .category-value {
            font-size: 14px;
            font-weight: 600;
            text-align: right;
        }

        .category-value.positive {
            color: var(--color-success);
        }

        .category-value.negative {
            color: var(--color-danger);
        }

        .budget-input {
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            text-align: right;
            font-weight: 600;
            background: var(--color-surface);
            width: 100%;
        }

        .budget-input:focus {
            outline: none;
            border-color: var(--color-primary);
            background: rgba(32, 128, 137, 0.05);
        }

        .category-delete {
            color: var(--color-danger);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
            text-align: center;
        }

        .category-row:hover .category-delete {
            opacity: 1;
        }

        .add-category-btn {
            width: 100%;
            padding: var(--spacing-md);
            background: transparent;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            font-size: 13px;
            cursor: pointer;
            margin-bottom: var(--spacing-lg);
            transition: all 0.2s;
        }

        .add-category-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        /* Transaction Buttons */
        .transaction-buttons {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-lg) var(--spacing-2xl);
            justify-content: center;
        }

        .transaction-btn {
            padding: var(--spacing-md) var(--spacing-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .payment-btn {
            background: var(--color-danger);
            color: white;
        }

        .payment-btn:hover {
            background: #dc2626;
            box-shadow: var(--shadow-md);
        }

        .deposit-btn {
            background: var(--color-success);
            color: white;
        }

        .deposit-btn:hover {
            background: #16a34a;
            box-shadow: var(--shadow-md);
        }

        .transfer-btn {
            background: var(--color-primary);
            color: white;
        }

        .transfer-btn:hover {
            background: var(--color-primary-hover);
            box-shadow: var(--shadow-md);
        }

        .salary-btn {
            background: #16a34a; /* Darker green than deposit */
            color: white;
        }

        .salary-btn:hover {
            background: #15803d;
            box-shadow: var(--shadow-md);
        }

        /* Transactions List */
        .transactions-section {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }

        .transactions-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(32, 128, 137, 0.05);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transaction-item {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 1fr 80px 40px;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--color-border);
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .transaction-item:hover {
            background: rgba(32, 128, 137, 0.05);
        }

        .transaction-icon {
            font-size: 20px;
            text-align: center;
        }

        .transaction-description {
            font-size: 14px;
            font-weight: 500;
        }

        .transaction-category {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .transaction-amount {
            font-size: 14px;
            font-weight: 600;
            text-align: right;
        }

        .transaction-amount.income {
            color: var(--color-success);
        }

        .transaction-amount.expense {
            color: var(--color-danger);
        }

        .transaction-date {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-align: right;
        }

        .transaction-account {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .transaction-delete {
            color: var(--color-danger, #ef4444);
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            padding: 0 var(--spacing-sm);
            opacity: 0;
            transition: opacity 0.2s;
            text-align: center;
        }

        .transaction-item:hover .transaction-delete {
            opacity: 1;
        }

        .transaction-delete:hover {
            color: #dc2626;
            transform: scale(1.2);
        }

        .form-textarea {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text);
        }

        .form-input, .form-select {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .btn {
            flex: 1;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: rgba(94, 82, 64, 0.1);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.2);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--color-text-secondary);
        }

        /* Recurring Bills Section */
        .recurring-bills-section {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin: var(--spacing-xl) var(--spacing-2xl);
            border: 1px solid var(--color-border);
        }

        .recurring-bills-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .recurring-bills-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .add-recurring-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-recurring-btn:hover {
            background: var(--color-primary-hover);
        }

        .recurring-bills-list {
            display: grid;
            gap: var(--spacing-md);
        }

        .recurring-bill-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: var(--spacing-lg);
            align-items: center;
            padding: var(--spacing-lg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .recurring-bill-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .recurring-bill-info {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .recurring-bill-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
        }

        .recurring-bill-meta {
            font-size: 12px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .recurring-bill-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-text);
        }

        .recurring-bill-due {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .recurring-bill-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .bill-action-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--color-border);
            background: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bill-action-btn:hover {
            background: var(--color-background);
        }

        .bill-action-btn.delete {
            color: var(--color-danger);
            border-color: var(--color-danger);
        }

        .bill-action-btn.delete:hover {
            background: var(--color-danger);
            color: white;
        }

        .frequency-badge {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(32, 128, 137, 0.1);
            color: var(--color-primary);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: capitalize;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .accounts-sidebar {
                display: none;
            }
        }

        /* ===== MOBILE RESPONSIVE FIXES ===== */

        /* Mobile (< 768px) */
        @media (max-width: 768px) {
            /* Layout */
            .layout {
                flex-direction: column;
            }
            
            /* Top Bar - Stack vertically */
            .top-bar {
                flex-direction: column;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
            }
            
            .top-bar-left {
                width: 100%;
                justify-content: space-between;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            /* Transaction Buttons - 2x2 grid */
            .transaction-buttons {
                flex-wrap: wrap;
                padding: var(--spacing-md);
            }
            
            .transaction-btn {
                flex: 1 1 45%;
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 12px;
            }
            
            /* Budget Overview - responsive */
            .budget-overview {
                margin: var(--spacing-md);
                padding: var(--spacing-md);
            }
            
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-sm);
            }
            
            .overview-value {
                font-size: 16px;
            }
            
            .to-budget-value {
                font-size: 24px;
            }
            
            /* Transactions - simplified grid for mobile */
            .transaction-item {
                grid-template-columns: 30px 1fr auto 30px;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .transaction-category,
            .transaction-date,
            .transaction-account {
                display: none;  /* Hide on mobile for cleaner view */
            }
            
            /* Categories Section */
            .categories-section {
                padding: var(--spacing-md);
            }
            
            .category-row {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }
            
            .category-value {
                text-align: left;
            }
            
            /* Recurring Bills */
            .recurring-bills-section {
                margin: var(--spacing-md);
                padding: var(--spacing-md);
            }
            
            .recurring-bill-item {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }
            
            .recurring-bill-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            /* Modal adjustments */
            .modal-content {
                margin: var(--spacing-sm);
                max-height: 95vh;
                width: calc(100% - 32px);
            }
        }

        /* Small phones (< 480px) */
        @media (max-width: 480px) {
            .transaction-btn {
                flex: 1 1 100%;
                margin-bottom: var(--spacing-xs);
            }
            
            .month-selector {
                width: 100%;
                justify-content: center;
            }
        }

        /* Mobile Accounts Bar & Drawer */
        .mobile-accounts-bar {
            display: none;
            padding: var(--spacing-md);
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
        }

        @media (max-width: 1024px) {
            .mobile-accounts-bar {
                display: block;
            }
        }

        .mobile-accounts-toggle {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: rgba(32, 128, 137, 0.1);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
            cursor: pointer;
        }

        .mobile-accounts-drawer {
            display: none;
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--spacing-md);
            max-height: 300px;
            overflow-y: auto;
        }

        .mobile-accounts-drawer.active {
            display: block;
        }

        .mobile-account-section {
            margin-bottom: var(--spacing-md);
        }

        .mobile-section-header {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
        }

        .mobile-account-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-background);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
            cursor: pointer;
        }

        .mobile-account-item.active {
            background: var(--color-primary);
            color: white;
        }

        .mobile-add-account-btn {
            width: 100%;
            padding: var(--spacing-md);
            background: transparent;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            font-size: 13px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="accounts-sidebar">
            <a href="/" class="sidebar-title">üí∞ CrewWealth</a>

            <div class="account-section">
                <div class="account-section-header">
                    <span>All accounts</span>
                    <span id="allAccountsTotal">‚Ç¨0.00</span>
                </div>
            </div>

            <div class="account-section">
                <div class="account-section-header">
                    <span>On budget</span>
                    <span id="onBudgetTotal">‚Ç¨0.00</span>
                </div>
                <div id="onBudgetAccounts"></div>
            </div>

            <div class="account-section">
                <div class="account-section-header">
                    <span>Off budget</span>
                    <span id="offBudgetTotal">‚Ç¨0.00</span>
                </div>
                <div id="offBudgetAccounts"></div>
            </div>

            <button class="add-account-btn" onclick="openModal('addAccountModal')">+ Add account</button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <a href="/" class="back-btn">‚Üê Dashboard</a>
                    <h1 class="page-title">Budget</h1>
                </div>
                <div class="month-selector">
                    <button class="month-btn" onclick="changeMonth(-1)">‚óÄ</button>
                    <div class="current-month" id="currentMonth">January 2026</div>
                    <button class="month-btn" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
            </div>

            <!-- Mobile Accounts Bar -->
            <div class="mobile-accounts-bar">
                <button class="mobile-accounts-toggle" 
                        onclick="toggleMobileAccounts()" 
                        aria-expanded="false" 
                        aria-controls="mobileAccountsDrawer"
                        aria-label="Toggle accounts menu">
                    <span aria-hidden="true">üí≥</span> Accounts <span id="mobileAccountsTotal">‚Ç¨0.00</span>
                    <span class="toggle-arrow" aria-hidden="true">‚ñº</span>
                </button>
            </div>

            <div class="mobile-accounts-drawer" id="mobileAccountsDrawer">
                <div class="mobile-drawer-content">
                    <div class="mobile-account-section">
                        <div class="mobile-section-header">All Accounts</div>
                        <div id="mobileAllAccountsTotal">‚Ç¨0.00</div>
                    </div>
                    <div class="mobile-account-section">
                        <div class="mobile-section-header">On Budget</div>
                        <div id="mobileOnBudgetAccounts"></div>
                    </div>
                    <div class="mobile-account-section">
                        <div class="mobile-section-header">Off Budget</div>
                        <div id="mobileOffBudgetAccounts"></div>
                    </div>
                    <button class="mobile-add-account-btn" onclick="openModal('addAccountModal')"><span aria-hidden="true">+</span> Add Account</button>
                </div>
            </div>

            <!-- Transaction Buttons -->
            <div class="transaction-buttons">
                <button class="transaction-btn salary-btn" onclick="openSalaryModal()">
                    üí∞ Add Salary
                </button>
                <button class="transaction-btn payment-btn" onclick="openPaymentModal()">
                    üí∏ New Payment
                </button>
                <button class="transaction-btn deposit-btn" onclick="openDepositModal()">
                    üí∞ New Deposit
                </button>
                <button class="transaction-btn transfer-btn" onclick="openTransferModal()">
                    üîÑ Transfer
                </button>
            </div>

            <div class="budget-overview">
                <div class="overview-grid">
                    <div class="overview-item">
                        <div class="overview-label">Available funds</div>
                        <div class="overview-value" id="availableFunds">‚Ç¨0.00</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Overspent</div>
                        <div class="overview-value" id="overspent">‚Ç¨0.00</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Budgeted</div>
                        <div class="overview-value" id="budgeted">‚Ç¨0.00</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Total spent</div>
                        <div class="overview-value" id="totalSpent">‚Ç¨0.00</div>
                    </div>
                </div>
                <div class="to-budget">
                    <div class="to-budget-label">To Budget</div>
                    <div class="to-budget-value" id="toBudget">‚Ç¨0.00</div>
                </div>
            </div>

            <!-- Recurring Bills Section -->
            <div class="recurring-bills-section">
                <div class="recurring-bills-header">
                    <h2 class="recurring-bills-title">üìÖ Recurring Bills</h2>
                    <button class="add-recurring-btn" onclick="openModal('addRecurringModal')">+ Add Recurring Bill</button>
                </div>
                <div id="recurringBillsContainer">
                    <div class="loading">No recurring bills yet</div>
                </div>
            </div>

            <div class="categories-section">
                <div class="transactions-section">
                    <div class="transactions-header">Recent Transactions</div>
                    <div id="transactionsContainer">
                        <div class="loading">No transactions yet</div>
                    </div>
                </div>
                <div id="categoriesContainer">
                    <div class="loading">Loading categories...</div>
                </div>
                <button class="add-category-btn" onclick="openModal('addCategoryModal')">+ Add category</button>
            </div>
        </main>
    </div>

    <!-- Add Account Modal -->
    <div class="modal" id="addAccountModal">
        <div class="modal-content">
            <div class="modal-header">Add Account</div>
            <form onsubmit="saveAccount(event)">
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" id="accountName" placeholder="e.g., Checking Account" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Starting Balance (<span class="currency-symbol">‚Ç¨</span>)</label>
                    <input type="number" class="form-input" id="accountBalance" step="0.01" value="0.00" required>
                </div>
                <div class="form-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="accountOffBudget">
                        <span>Off Budget (Investments/Savings)</span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addAccountModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">Add Category</div>
            <form onsubmit="saveCategory(event)">
                <div class="form-group">
                    <label class="form-label">Category Group</label>
                    <select class="form-select" id="categoryGroup" required>
                        <option value="expenses">üí∏ Daily Expenses</option>
                        <option value="savings">üí∞ Savings Goals</option>
                        <option value="bills">üìÑ Monthly Bills</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category Name</label>
                    <input type="text" class="form-input" id="categoryName" placeholder="e.g., Groceries" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCategoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment/Expense Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">New Payment</div>
            <form onsubmit="savePayment(event)">
                <div class="form-group">
                    <label class="form-label">Amount (<span class="currency-symbol">‚Ç¨</span>) *</label>
                    <input type="number" class="form-input" id="paymentAmount" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Account *</label>
                    <select class="form-select" id="paymentAccount" required>
                        <option value="">Select account...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="paymentCategory">
                        <option value="">Uncategorized</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Note/Description</label>
                    <textarea class="form-textarea" id="paymentNote" placeholder="Optional note..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Deposit/Income Modal -->
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <div class="modal-header">New Deposit</div>
            <form onsubmit="saveDeposit(event)">
                <div class="form-group">
                    <label class="form-label">Amount (<span class="currency-symbol">‚Ç¨</span>) *</label>
                    <input type="number" class="form-input" id="depositAmount" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Account *</label>
                    <select class="form-select" id="depositAccount" required>
                        <option value="">Select account...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="depositCategory">
                        <option value="">Uncategorized</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="depositDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Note/Description</label>
                    <textarea class="form-textarea" id="depositNote" placeholder="Optional note..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('depositModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Deposit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <div class="modal-header">Transfer Money</div>
            <form onsubmit="saveTransfer(event)">
                <div class="form-group">
                    <label class="form-label">Amount (<span class="currency-symbol">‚Ç¨</span>) *</label>
                    <input type="number" class="form-input" id="transferAmount" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label class="form-label">From Account *</label>
                    <select class="form-select" id="transferFromAccount" onchange="updateTransferToAccount()" required>
                        <option value="">Select account...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">To Account *</label>
                    <select class="form-select" id="transferToAccount" required>
                        <option value="">Select account...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="transferDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Note/Description</label>
                    <textarea class="form-textarea" id="transferNote" placeholder="Optional note..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('transferModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Complete Transfer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Salary Modal -->
    <div class="modal" id="salaryModal">
        <div class="modal-content">
            <div class="modal-header">Add Salary</div>
            <form onsubmit="saveSalary(event)">
                <div class="form-group">
                    <label class="form-label">Amount (<span class="currency-symbol">‚Ç¨</span>) *</label>
                    <input type="number" class="form-input" id="salaryAmount" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Account *</label>
                    <select class="form-select" id="salaryAccount" required>
                        <option value="">Select account...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="salaryDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Note</label>
                    <input type="text" class="form-input" id="salaryNote" placeholder="e.g., January 2026 Salary" value="Salary">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('salaryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Salary</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal" id="editTransactionModal">
        <div class="modal-content">
            <div class="modal-header" id="editModalHeader">Edit Transaction</div>
            <form onsubmit="saveEditedTransaction(event)">
                <input type="hidden" id="editTransactionId">
                <input type="hidden" id="editTransactionType">
                <input type="hidden" id="editOriginalAmount">
                <input type="hidden" id="editOriginalAccountId">
                <input type="hidden" id="editOriginalToAccountId">

                <!-- Payment/Deposit/Salary Fields -->
                <div id="editStandardFields">
                    <div class="form-group">
                        <label class="form-label">Amount (<span class="currency-symbol">‚Ç¨</span>) *</label>
                        <input type="number" class="form-input" id="editAmount" step="0.01" min="0.01" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Account *</label>
                        <select class="form-select" id="editAccount" required>
                            <option value="">Select account...</option>
                        </select>
                    </div>

                    <div class="form-group" id="editCategoryGroup">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="editCategory">
                            <option value="">Select category...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-input" id="editDate" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Note</label>
                        <textarea class="form-textarea" id="editNote" placeholder="Description"></textarea>
                    </div>
                </div>

                <!-- Transfer Fields -->
                <div id="editTransferFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Amount (<span class="currency-symbol">‚Ç¨</span>) *</label>
                        <input type="number" class="form-input" id="editTransferAmount" step="0.01" min="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">From Account *</label>
                        <select class="form-select" id="editFromAccount">
                            <option value="">Select account...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">To Account *</label>
                        <select class="form-select" id="editToAccount">
                            <option value="">Select account...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-input" id="editTransferDate">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Note</label>
                        <textarea class="form-textarea" id="editTransferNote" placeholder="Description"></textarea>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editTransactionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Recurring Transaction Modal -->
    <div class="modal" id="addRecurringModal">
        <div class="modal-content">
            <div class="modal-header">Add Recurring Bill</div>
            <form onsubmit="saveRecurringTransaction(event)">
                <div class="form-group">
                    <label class="form-label">Bill Name *</label>
                    <input type="text" class="form-input" id="recurringName" placeholder="e.g., Rent, Netflix" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (<span class="currency-symbol">‚Ç¨</span>) *</label>
                    <input type="number" class="form-input" id="recurringAmount" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="recurringCategory">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Frequency *</label>
                    <select class="form-select" id="recurringFrequency" onchange="updateRecurringDateFields()" required>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="monthly" selected>Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group" id="dayOfMonthGroup">
                    <label class="form-label">Day of Month (1-31) *</label>
                    <input type="number" class="form-input" id="recurringDayOfMonth" min="1" max="31" placeholder="1" value="1">
                </div>
                <div class="form-group" id="dayOfWeekGroup" style="display: none;">
                    <label class="form-label">Day of Week *</label>
                    <select class="form-select" id="recurringDayOfWeek">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Next Due Date *</label>
                    <input type="date" class="form-input" id="recurringNextDue" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addRecurringModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Recurring Bill</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Recurring Transaction Modal -->
    <div class="modal" id="editRecurringModal">
        <div class="modal-content">
            <div class="modal-header">Edit Recurring Bill</div>
            <form onsubmit="updateRecurringTransaction(event)">
                <input type="hidden" id="editRecurringId">
                <div class="form-group">
                    <label class="form-label">Bill Name *</label>
                    <input type="text" class="form-input" id="editRecurringName" placeholder="e.g., Rent, Netflix" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (<span class="currency-symbol">‚Ç¨</span>) *</label>
                    <input type="number" class="form-input" id="editRecurringAmount" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="editRecurringCategory">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Frequency *</label>
                    <select class="form-select" id="editRecurringFrequency" onchange="updateEditRecurringDateFields()" required>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group" id="editDayOfMonthGroup">
                    <label class="form-label">Day of Month (1-31) *</label>
                    <input type="number" class="form-input" id="editRecurringDayOfMonth" min="1" max="31" placeholder="1">
                </div>
                <div class="form-group" id="editDayOfWeekGroup" style="display: none;">
                    <label class="form-label">Day of Week *</label>
                    <select class="form-select" id="editRecurringDayOfWeek">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Next Due Date *</label>
                    <input type="date" class="form-input" id="editRecurringNextDue" required>
                </div>
                <div class="form-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="editRecurringIsActive">
                        <span>Active</span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editRecurringModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBccv9C4CpjZFeE2HGBKKfUiV9jUw8CZLo",
            authDomain: "crewwealth-cbe02.firebaseapp.com",
            projectId: "crewwealth-cbe02",
            storageBucket: "crewwealth-cbe02.firebasestorage.app",
            messagingSenderId: "852834158589",
            appId: "1:852834158589:web:8201ed1d9327841773bb94"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // GLOBAL STATE
        // ============================================
        let currentUser = null;
        let accounts = [];
        let categories = [];
        let budgets = {};
        let transactions = [];
        let currentDate = new Date();
        let selectedAccountId = null; // null = "All Accounts" view, else specific account ID
        let userCurrency = 'EUR'; // global variable for currency

        // ============================================
        // CURRENCY FUNCTIONS
        // ============================================
        function formatCurrency(amount) {
            const currencyConfig = {
                'USD': { symbol: '$', decimals: 2 },
                'EUR': { symbol: '‚Ç¨', decimals: 2 },
                'GBP': { symbol: '¬£', decimals: 2 },
                'PHP': { symbol: '‚Ç±', decimals: 2 },
                'INR': { symbol: '‚Çπ', decimals: 2 },
                'IDR': { symbol: 'Rp', decimals: 0 },
                'SGD': { symbol: 'S$', decimals: 2 },
                'NOK': { symbol: 'kr', decimals: 2 },
                'AUD': { symbol: 'A$', decimals: 2 },
                'CAD': { symbol: 'C$', decimals: 2 },
                'JPY': { symbol: '¬•', decimals: 0 }
            };
            
            const config = currencyConfig[userCurrency] || currencyConfig['EUR'];
            const formatted = (amount || 0).toFixed(config.decimals)
                .replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            return config.symbol + formatted;
        }

        function getCurrencySymbol() {
            const symbols = {
                'EUR': '‚Ç¨', 'USD': '$', 'GBP': '¬£', 'PHP': '‚Ç±',
                'INR': '‚Çπ', 'AUD': 'A$', 'CAD': 'C$', 'SGD': 'S$',
                'NOK': 'kr', 'JPY': '¬•'
            };
            return symbols[userCurrency] || '‚Ç¨';
        }

        function updateCurrencyLabels() {
            document.querySelectorAll('.currency-symbol').forEach(el => {
                el.textContent = getCurrencySymbol();
            });
        }

        async function loadUserSettings() {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    userCurrency = doc.data().settings?.currency || 'EUR';
                    updateCurrencyLabels();
                }
            } catch (error) {
                console.error('Error loading user settings:', error);
            }
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                console.log('‚ùå Not authenticated, redirecting to login...');
                window.location.href = '/login';
                return;
            }
            
            console.log('‚úÖ User authenticated:', user.email);
            currentUser = user;
            await loadUserSettings();
            await initializeDashboard();
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        async function initializeDashboard() {
            try {
                updateMonthDisplay();
                await loadAllData();
                renderAccounts();
                renderCategories();
                renderTransactions();
                updateOverview();
                console.log('‚úÖ Dashboard initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing dashboard:', error);
                showError('Failed to load dashboard. Please refresh the page.');
            }
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadAllData() {
            if (!currentUser) return;

            const userId = currentUser.uid;
            const monthKey = getMonthKey();

            try {
                // Load accounts
                const accountsSnapshot = await db.collection('users').doc(userId)
                    .collection('accounts').get();
                accounts = accountsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load categories
                const categoriesSnapshot = await db.collection('users').doc(userId)
                    .collection('categories').get();
                categories = categoriesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load budgets for current month
                const budgetDoc = await db.collection('users').doc(userId)
                    .collection('budgets').doc(monthKey).get();
                budgets = budgetDoc.exists ? { [monthKey]: budgetDoc.data() } : { [monthKey]: {} };

                // Load transactions
                const transactionsSnapshot = await db.collection('users').doc(userId)
                    .collection('transactions').get();
                transactions = transactionsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log('‚úÖ Data loaded:', {
                    accounts: accounts.length,
                    categories: categories.length,
                    transactions: transactions.length
                });

                // Load recurring transactions
                await loadRecurringTransactions();

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                throw error;
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function getMonthKey() {
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateMonthDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[currentDate.getMonth()];
            const year = currentDate.getFullYear();
            document.getElementById('currentMonth').textContent = `${monthName} ${year}`;
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            updateMonthDisplay();
            loadAllData().then(() => {
                renderCategories();
                updateOverview();
            });
        }

        function showError(message) {
            alert(message); // Kan later vervangen worden door een mooiere UI-melding
        }

        // ============================================
        // ACCOUNT SELECTION FUNCTIONS
        // ============================================
        function selectAccount(accountId) {
            selectedAccountId = accountId;
            updateAccountSelection();
            renderTransactions();
        }

        function updateAccountSelection() {
            // Remove .active from all account items
            document.querySelectorAll('.account-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove .active from all section headers
            document.querySelectorAll('.account-section-header').forEach(header => {
                header.classList.remove('active');
            });
            
            // Add .active to selected
            if (selectedAccountId === null) {
                // Highlight "All accounts" header
                const allAccountsHeader = document.querySelector('.account-section-header');
                if (allAccountsHeader) {
                    allAccountsHeader.classList.add('active');
                }
            } else {
                // Find and highlight specific account
                const accountElements = document.querySelectorAll('.account-item');
                accountElements.forEach(el => {
                    if (el.dataset && el.dataset.accountId === selectedAccountId) {
                        el.classList.add('active');
                    }
                });
            }
        }

        // Mobile Accounts Functions
        function toggleMobileAccounts() {
            const drawer = document.getElementById('mobileAccountsDrawer');
            const toggle = document.querySelector('.mobile-accounts-toggle');
            const arrow = document.querySelector('.toggle-arrow');
            const isExpanded = drawer.classList.toggle('active');
            
            arrow.textContent = isExpanded ? '‚ñ≤' : '‚ñº';
            toggle.setAttribute('aria-expanded', isExpanded);
        }

        function renderMobileAccounts() {
            const mobileOnBudget = document.getElementById('mobileOnBudgetAccounts');
            const mobileOffBudget = document.getElementById('mobileOffBudgetAccounts');
            
            if (!mobileOnBudget || !mobileOffBudget) return;
            
            mobileOnBudget.innerHTML = '';
            mobileOffBudget.innerHTML = '';
            
            let total = 0;
            
            accounts.forEach(account => {
                const balance = parseFloat(account.balance) || 0;
                total += balance;
                
                const div = document.createElement('div');
                div.className = 'mobile-account-item' + (selectedAccountId === account.id ? ' active' : '');
                div.setAttribute('role', 'button');
                div.setAttribute('tabindex', '0');
                div.setAttribute('aria-label', `Select ${account.name} account, balance ${formatCurrency(balance)}`);
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = account.name;
                
                const balanceSpan = document.createElement('span');
                balanceSpan.textContent = formatCurrency(balance);
                
                div.appendChild(nameSpan);
                div.appendChild(balanceSpan);
                
                div.onclick = () => {
                    selectAccount(account.id);
                };
                
                div.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectAccount(account.id);
                    }
                };
                
                if (account.offBudget) {
                    mobileOffBudget.appendChild(div);
                } else {
                    mobileOnBudget.appendChild(div);
                }
            });
            
            document.getElementById('mobileAccountsTotal').textContent = formatCurrency(total);
            document.getElementById('mobileAllAccountsTotal').textContent = formatCurrency(total);
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function renderAccounts() {
            const onBudgetContainer = document.getElementById('onBudgetAccounts');
            const offBudgetContainer = document.getElementById('offBudgetAccounts');

            onBudgetContainer.innerHTML = '';
            offBudgetContainer.innerHTML = '';

            let allTotal = 0;
            let onBudgetTotal = 0;
            let offBudgetTotal = 0;

            accounts.forEach(account => {
                const balance = parseFloat(account.balance) || 0;
                const div = document.createElement('div');
                div.className = 'account-item';
                div.dataset.accountId = account.id; // Add data attribute for selection
                div.tabIndex = 0; // Make keyboard accessible
                
                // Create child elements safely
                const nameSpan = document.createElement('span');
                nameSpan.className = 'account-name';
                nameSpan.textContent = account.name;
                
                const balanceSpan = document.createElement('span');
                balanceSpan.className = 'account-balance';
                balanceSpan.textContent = formatCurrency(balance);
                
                const deleteSpan = document.createElement('span');
                deleteSpan.className = 'account-delete';
                deleteSpan.textContent = '√ó';
                deleteSpan.onclick = (e) => {
                    e.stopPropagation();
                    deleteAccount(account.id);
                };
                
                div.appendChild(nameSpan);
                div.appendChild(balanceSpan);
                div.appendChild(deleteSpan);
                
                // Make account clickable with mouse and keyboard
                div.onclick = () => selectAccount(account.id);
                div.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectAccount(account.id);
                    }
                };

                if (account.offBudget) {
                    offBudgetContainer.appendChild(div);
                    offBudgetTotal += balance;
                } else {
                    onBudgetContainer.appendChild(div);
                    onBudgetTotal += balance;
                }

                allTotal += balance;
            });

            document.getElementById('allAccountsTotal').textContent = formatCurrency(allTotal);
            document.getElementById('onBudgetTotal').textContent = formatCurrency(onBudgetTotal);
            document.getElementById('offBudgetTotal').textContent = formatCurrency(offBudgetTotal);
            
            // Make "All accounts" header clickable with keyboard support
            const allAccountsHeader = document.querySelector('.account-section-header');
            if (allAccountsHeader) {
                allAccountsHeader.style.cursor = 'pointer';
                allAccountsHeader.tabIndex = 0;
                allAccountsHeader.onclick = () => selectAccount(null);
                allAccountsHeader.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectAccount(null);
                    }
                };
            }
            
            // Update visual selection
            updateAccountSelection();
            
            // Update mobile accounts
            renderMobileAccounts();
        }

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            const monthKey = getMonthKey();
            const currentBudgets = budgets[monthKey] || {};

            const groups = {
                expenses: { name: 'üí∏ Daily Expenses', categories: [] },
                savings: { name: 'üí∞ Savings Goals', categories: [] },
                bills: { name: 'üìÑ Monthly Bills', categories: [] }
            };

            // Group categories
            categories.forEach(cat => {
                if (groups[cat.group]) {
                    groups[cat.group].categories.push(cat);
                }
            });

            // Render each group
            Object.entries(groups).forEach(([groupKey, group]) => {
                if (group.categories.length === 0) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'category-group';

                let groupBudgeted = 0;
                let groupSpent = 0;

                group.categories.forEach(cat => {
                    const budgeted = currentBudgets[cat.id] || 0;
                    const spent = calculateSpent(cat.id, monthKey);
                    groupBudgeted += budgeted;
                    groupSpent += spent;
                });

                const groupAvailable = groupBudgeted - groupSpent;

                groupDiv.innerHTML = `
                    <div class="category-group-header">
                        <span class="category-group-name">${group.name}</span>
                        <div class="category-group-totals">
                            <span>Budgeted: ${formatCurrency(groupBudgeted)}</span>
                            <span>Spent: ${formatCurrency(groupSpent)}</span>
                            <span>Available: ${formatCurrency(groupAvailable)}</span>
                        </div>
                    </div>
                `;

                // Render categories in group
                group.categories.forEach(cat => {
                    const budgeted = currentBudgets[cat.id] || 0;
                    const spent = calculateSpent(cat.id, monthKey);
                    const available = budgeted - spent;

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'category-row';
                    rowDiv.innerHTML = `
                        <div class="category-name">${escapeHtml(cat.name)}</div>
                        <div>
                            <input type="number" 
                                   class="budget-input" 
                                   value="${budgeted.toFixed(2)}" 
                                   step="0.01"
                                   onchange="updateBudget('${cat.id}', this.value)">
                        </div>
                        <div class="category-value">${formatCurrency(spent)}</div>
                        <div class="category-value ${available >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(available)}
                        </div>
                        <div class="category-delete" onclick="deleteCategory('${cat.id}')">√ó</div>
                    `;
                    groupDiv.appendChild(rowDiv);
                });

                container.appendChild(groupDiv);
            });

            // Show message if no categories
            if (categories.length === 0) {
                container.innerHTML = '<div class="loading">No categories yet. Add your first category!</div>';
            }
        }

        function calculateSpent(categoryId, monthKey) {
            // Parse the monthKey to get year and month
            const [year, month] = monthKey.split('-').map(Number);
            
            return transactions
                .filter(t => {
                    if (!t.date || t.categoryId !== categoryId || t.type !== 'payment') return false;
                    
                    // Account filter - only include if no specific account selected or matches selected account
                    const accountMatch = selectedAccountId === null || t.accountId === selectedAccountId;
                    if (!accountMatch) return false;
                    
                    // Convert Firestore timestamp to Date if needed
                    let txDate;
                    if (t.date.toDate) {
                        txDate = t.date.toDate();
                    } else if (typeof t.date === 'string') {
                        txDate = new Date(t.date);
                    } else {
                        txDate = new Date(t.date);
                    }
                    
                    return txDate.getFullYear() === year && txDate.getMonth() === month - 1;
                })
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
        }

        function updateOverview() {
            const monthKey = getMonthKey();
            const currentBudgets = budgets[monthKey] || {};

            // Calculate available funds (sum of on-budget accounts)
            const onBudgetAccounts = accounts.filter(a => !a.offBudget);
            const availableFunds = onBudgetAccounts.reduce((sum, a) => sum + (parseFloat(a.balance) || 0), 0);

            // Calculate total budgeted
            const totalBudgeted = Object.values(currentBudgets).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);

            // Calculate total spent
            const totalSpent = categories.reduce((sum, cat) => sum + calculateSpent(cat.id, monthKey), 0);

            // Calculate to budget
            const toBudget = availableFunds - totalBudgeted;

            // Calculate overspent
            const overspent = categories.reduce((sum, cat) => {
                const budgeted = currentBudgets[cat.id] || 0;
                const spent = calculateSpent(cat.id, monthKey);
                const diff = spent - budgeted;
                return sum + (diff > 0 ? diff : 0);
            }, 0);

            // Update DOM
            document.getElementById('availableFunds').textContent = formatCurrency(availableFunds);
            document.getElementById('overspent').textContent = formatCurrency(overspent);
            document.getElementById('budgeted').textContent = formatCurrency(totalBudgeted);
            document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);
            document.getElementById('toBudget').textContent = formatCurrency(toBudget);
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function openModal(modalId) {
            // Populate category dropdown for recurring transaction modals
            if (modalId === 'addRecurringModal') {
                const categorySelect = document.getElementById('recurringCategory');
                categorySelect.innerHTML = '<option value="">Select category...</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    categorySelect.appendChild(option);
                });
                
                // Set default next due date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('recurringNextDue').value = today;
            }
            
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ============================================
        // CRUD OPERATIONS - ACCOUNTS
        // ============================================
        async function saveAccount(event) {
            event.preventDefault();

            if (!currentUser) {
                showError('You must be logged in');
                return;
            }

            const name = document.getElementById('accountName').value.trim();
            const balance = parseFloat(document.getElementById('accountBalance').value) || 0;
            const offBudget = document.getElementById('accountOffBudget').checked;

            // Validation
            if (!name) {
                showError('Account name is required');
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('accounts').add({
                        name: name,
                        balance: balance,
                        offBudget: offBudget,
                        createdAt: new Date().toISOString()
                    });

                // Reset form and close modal
                document.getElementById('accountName').value = '';
                document.getElementById('accountBalance').value = '0.00';
                document.getElementById('accountOffBudget').checked = false;
                closeModal('addAccountModal');

                // Reload data
                await loadAllData();
                renderAccounts();
                updateOverview();

                console.log('‚úÖ Account added successfully');
            } catch (error) {
                console.error('‚ùå Error saving account:', error);
                showError('Failed to save account: ' + error.message);
            }
        }

        async function deleteAccount(accountId) {
            if (!confirm('Are you sure you want to delete this account?')) return;

            if (!currentUser) {
                showError('You must be logged in');
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('accounts').doc(accountId).delete();

                await loadAllData();
                renderAccounts();
                updateOverview();

                console.log('‚úÖ Account deleted successfully');
            } catch (error) {
                console.error('‚ùå Error deleting account:', error);
                showError('Failed to delete account: ' + error.message);
            }
        }

        // ============================================
        // CRUD OPERATIONS - CATEGORIES
        // ============================================
        async function saveCategory(event) {
            event.preventDefault();

            if (!currentUser) {
                showError('You must be logged in');
                return;
            }

            const group = document.getElementById('categoryGroup').value;
            const name = document.getElementById('categoryName').value.trim();

            // Validation
            if (!name) {
                showError('Category name is required');
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('categories').add({
                        name: name,
                        group: group,
                        createdAt: new Date().toISOString()
                    });

                // Reset form and close modal
                document.getElementById('categoryName').value = '';
                document.getElementById('categoryGroup').value = 'expenses';
                closeModal('addCategoryModal');

                // Reload data
                await loadAllData();
                renderCategories();

                console.log('‚úÖ Category added successfully');
            } catch (error) {
                console.error('‚ùå Error saving category:', error);
                showError('Failed to save category: ' + error.message);
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category?')) return;

            if (!currentUser) {
                showError('You must be logged in');
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('categories').doc(categoryId).delete();

                await loadAllData();
                renderCategories();
                updateOverview();

                console.log('‚úÖ Category deleted successfully');
            } catch (error) {
                console.error('‚ùå Error deleting category:', error);
                showError('Failed to delete category: ' + error.message);
            }
        }

        // ============================================
        // CRUD OPERATIONS - BUDGETS
        // ============================================
        async function updateBudget(categoryId, value) {
            if (!currentUser) {
                showError('You must be logged in');
                return;
            }

            const monthKey = getMonthKey();
            const newValue = parseFloat(value) || 0;

            // Validation
            if (newValue < 0) {
                showError('Budget cannot be negative');
                return;
            }

            try {
                // Update local state
                if (!budgets[monthKey]) {
                    budgets[monthKey] = {};
                }
                budgets[monthKey][categoryId] = newValue;

                // Save to Firestore
                await db.collection('users').doc(currentUser.uid)
                    .collection('budgets').doc(monthKey).set(budgets[monthKey]);

                // Update UI
                updateOverview();
                renderCategories();

                console.log('‚úÖ Budget updated successfully');
            } catch (error) {
                console.error('‚ùå Error updating budget:', error);
                showError('Failed to update budget: ' + error.message);
            }
        }

        // ============================================
        // TRANSACTION MODAL FUNCTIONS
        // ============================================
        function openPaymentModal() {
            // Set today's date
            document.getElementById('paymentDate').valueAsDate = new Date();
            
            // Populate accounts dropdown
            const accountSelect = document.getElementById('paymentAccount');
            accountSelect.innerHTML = '<option value="">Select account...</option>';
            accounts.forEach(acc => {
                accountSelect.innerHTML += `<option value="${acc.id}">${acc.name}</option>`;
            });
            
            // Populate categories dropdown (expense categories only)
            const categorySelect = document.getElementById('paymentCategory');
            categorySelect.innerHTML = '<option value="">Uncategorized</option>';
            categories.filter(cat => cat.group === 'expenses' || cat.group === 'bills').forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`;
            });
            
            openModal('paymentModal');
        }

        function openDepositModal() {
            // Set today's date
            document.getElementById('depositDate').valueAsDate = new Date();
            
            // Populate accounts dropdown
            const accountSelect = document.getElementById('depositAccount');
            accountSelect.innerHTML = '<option value="">Select account...</option>';
            accounts.forEach(acc => {
                accountSelect.innerHTML += `<option value="${acc.id}">${acc.name}</option>`;
            });
            
            // Populate categories dropdown (income/savings categories)
            const categorySelect = document.getElementById('depositCategory');
            categorySelect.innerHTML = '<option value="">Uncategorized</option>';
            categories.filter(cat => cat.group === 'savings').forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`;
            });
            
            openModal('depositModal');
        }

        function openTransferModal() {
            // Set today's date
            document.getElementById('transferDate').valueAsDate = new Date();
            
            // Populate from account dropdown
            const fromSelect = document.getElementById('transferFromAccount');
            fromSelect.innerHTML = '<option value="">Select account...</option>';
            accounts.forEach(acc => {
                fromSelect.innerHTML += `<option value="${acc.id}">${acc.name}</option>`;
            });
            
            // Populate to account dropdown
            updateTransferToAccount();
            
            openModal('transferModal');
        }

        function updateTransferToAccount() {
            const fromAccountId = document.getElementById('transferFromAccount').value;
            const toSelect = document.getElementById('transferToAccount');
            
            toSelect.innerHTML = '<option value="">Select account...</option>';
            accounts.filter(acc => acc.id !== fromAccountId).forEach(acc => {
                toSelect.innerHTML += `<option value="${acc.id}">${acc.name}</option>`;
            });
        }

        // ============================================
        // CRUD OPERATIONS - TRANSACTIONS
        // ============================================
        async function savePayment(event) {
            event.preventDefault();

            if (!currentUser) {
                showError('You must be logged in');
                return;
            }

            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const accountId = document.getElementById('paymentAccount').value;
            const categoryId = document.getElementById('paymentCategory').value || null;
            const date = document.getElementById('paymentDate').value;
            const note = document.getElementById('paymentNote').value.trim();

            // Validation
            if (!amount || amount <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            if (!accountId) {
                showError('Please select an account');
                return;
            }
            if (!date) {
                showError('Please select a date');
                return;
            }

            try {
                // Create transaction
                await db.collection('users').doc(currentUser.uid)
                    .collection('transactions').add({
                        type: 'payment',
                        amount: amount,
                        accountId: accountId,
                        categoryId: categoryId,
                        date: firebase.firestore.Timestamp.fromDate(new Date(date)),
                        note: note,
                        createdAt: firebase.firestore.Timestamp.now()
                    });

                // Update account balance
                const account = accounts.find(a => a.id === accountId);
                if (account) {
                    const newBalance = (parseFloat(account.balance) || 0) - amount;
                    await db.collection('users').doc(currentUser.uid)
                        .collection('accounts').doc(accountId).update({
                            balance: newBalance
                        });
                }

                // Reset form and close modal
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentNote').value = '';
                closeModal('paymentModal');

                // Reload data and update UI
                await loadAllData();
                renderAccounts();
                renderCategories();
                renderTransactions();
                updateOverview();

                console.log('‚úÖ Payment saved successfully');
            } catch (error) {
                console.error('‚ùå Error saving payment:', error);
                showError('Failed to save payment: ' + error.message);
            }
        }

        async function saveDeposit(event) {
            event.preventDefault();

            if (!currentUser) {
                showError('You must be logged in');
                return;
            }

            const amount = parseFloat(document.getElementById('depositAmount').value);
            const accountId = document.getElementById('depositAccount').value;
            const categoryId = document.getElementById('depositCategory').value || null;
            const date = document.getElementById('depositDate').value;
            const note = document.getElementById('depositNote').value.trim();

            // Validation
            if (!amount || amount <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            if (!accountId) {
                showError('Please select an account');
                return;
            }
            if (!date) {
                showError('Please select a date');
                return;
            }

            try {
                // Create transaction
                await db.collection('users').doc(currentUser.uid)
                    .collection('transactions').add({
                        type: 'deposit',
                        amount: amount,
                        accountId: accountId,
                        categoryId: categoryId,
                        date: firebase.firestore.Timestamp.fromDate(new Date(date)),
                        note: note,
                        createdAt: firebase.firestore.Timestamp.now()
                    });

                // Update account balance
                const account = accounts.find(a => a.id === accountId);
                if (account) {
                    const newBalance = (parseFloat(account.balance) || 0) + amount;
                    await db.collection('users').doc(currentUser.uid)
                        .collection('accounts').doc(accountId).update({
                            balance: newBalance
                        });
                }

                // Reset form and close modal
                document.getElementById('depositAmount').value = '';
                document.getElementById('depositNote').value = '';
                closeModal('depositModal');

                // Reload data and update UI
                await loadAllData();
                renderAccounts();
                renderCategories();
                renderTransactions();
                updateOverview();

                console.log('‚úÖ Deposit saved successfully');
            } catch (error) {
                console.error('‚ùå Error saving deposit:', error);
                showError('Failed to save deposit: ' + error.message);
            }
        }

        async function saveTransfer(event) {
            event.preventDefault();

            if (!currentUser) {
                showError('You must be logged in');
                return;
            }

            const amount = parseFloat(document.getElementById('transferAmount').value);
            const fromAccountId = document.getElementById('transferFromAccount').value;
            const toAccountId = document.getElementById('transferToAccount').value;
            const date = document.getElementById('transferDate').value;
            const note = document.getElementById('transferNote').value.trim();

            // Validation
            if (!amount || amount <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            if (!fromAccountId) {
                showError('Please select a source account');
                return;
            }
            if (!toAccountId) {
                showError('Please select a destination account');
                return;
            }
            if (fromAccountId === toAccountId) {
                showError('Source and destination accounts must be different');
                return;
            }
            if (!date) {
                showError('Please select a date');
                return;
            }

            try {
                // Create transaction
                await db.collection('users').doc(currentUser.uid)
                    .collection('transactions').add({
                        type: 'transfer',
                        amount: amount,
                        accountId: fromAccountId,
                        toAccountId: toAccountId,
                        date: firebase.firestore.Timestamp.fromDate(new Date(date)),
                        note: note,
                        createdAt: firebase.firestore.Timestamp.now()
                    });

                // Update from account balance
                const fromAccount = accounts.find(a => a.id === fromAccountId);
                if (fromAccount) {
                    const newBalance = (parseFloat(fromAccount.balance) || 0) - amount;
                    await db.collection('users').doc(currentUser.uid)
                        .collection('accounts').doc(fromAccountId).update({
                            balance: newBalance
                        });
                }

                // Update to account balance
                const toAccount = accounts.find(a => a.id === toAccountId);
                if (toAccount) {
                    const newBalance = (parseFloat(toAccount.balance) || 0) + amount;
                    await db.collection('users').doc(currentUser.uid)
                        .collection('accounts').doc(toAccountId).update({
                            balance: newBalance
                        });
                }

                // Reset form and close modal
                document.getElementById('transferAmount').value = '';
                document.getElementById('transferNote').value = '';
                closeModal('transferModal');

                // Reload data and update UI
                await loadAllData();
                renderAccounts();
                renderTransactions();
                updateOverview();

                console.log('‚úÖ Transfer completed successfully');
            } catch (error) {
                console.error('‚ùå Error completing transfer:', error);
                showError('Failed to complete transfer: ' + error.message);
            }
        }

        // ============================================
        // SALARY MODAL FUNCTIONS
        // ============================================
        function openSalaryModal() {
            document.getElementById('salaryDate').valueAsDate = new Date();
            
            const accountSelect = document.getElementById('salaryAccount');
            accountSelect.innerHTML = ''; // Clear existing options
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select account...';
            accountSelect.appendChild(defaultOption);
            
            // Add account options safely
            accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.name;
                accountSelect.appendChild(option);
            });
            
            openModal('salaryModal');
        }

        async function saveSalary(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('You must be logged in');
                return;
            }

            const amount = parseFloat(document.getElementById('salaryAmount').value);
            const accountId = document.getElementById('salaryAccount').value;
            const date = document.getElementById('salaryDate').value;
            const note = document.getElementById('salaryNote').value.trim() || 'Salary';

            // Validation
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            if (!accountId) {
                alert('Please select an account');
                return;
            }
            if (!date) {
                alert('Please select a date');
                return;
            }

            try {
                // Create salary transaction (type: 'salary', no categoryId)
                await db.collection('users').doc(currentUser.uid)
                    .collection('transactions').add({
                        type: 'salary',
                        amount: amount,
                        accountId: accountId,
                        categoryId: null, // Salary is not categorized
                        date: firebase.firestore.Timestamp.fromDate(new Date(date)),
                        note: note,
                        createdAt: firebase.firestore.Timestamp.now()
                    });

                // Update account balance (add salary)
                const account = accounts.find(a => a.id === accountId);
                if (account) {
                    const newBalance = (parseFloat(account.balance) || 0) + amount;
                    await db.collection('users').doc(currentUser.uid)
                        .collection('accounts').doc(accountId).update({
                            balance: newBalance
                        });
                }

                // Reset form and close modal
                document.getElementById('salaryAmount').value = '';
                document.getElementById('salaryNote').value = 'Salary';
                closeModal('salaryModal');

                // Reload data and update UI
                await loadAllData();
                renderAccounts();
                renderCategories();
                renderTransactions();
                updateOverview();

                console.log('‚úÖ Salary added successfully');
            } catch (error) {
                console.error('‚ùå Error adding salary:', error);
                alert('Failed to add salary: ' + error.message);
            }
        }

        // ============================================
        // DELETE TRANSACTION
        // ============================================
        async function deleteTransaction(transactionId, type, amount, accountId, toAccountId) {
            // Confirmation dialog
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            if (!currentUser) {
                alert('You must be logged in');
                return;
            }

            try {
                // Delete transaction from Firestore
                await db.collection('users').doc(currentUser.uid)
                    .collection('transactions').doc(transactionId).delete();

                // Update account balances based on transaction type
                if (type === 'payment') {
                    // Payment: Add back to account balance (we subtracted it before)
                    const account = accounts.find(a => a.id === accountId);
                    if (account) {
                        const newBalance = (parseFloat(account.balance) || 0) + amount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(accountId).update({
                                balance: newBalance
                            });
                    }
                } else if (type === 'deposit' || type === 'salary') {
                    // Deposit/Salary: Subtract from account balance (we added it before)
                    const account = accounts.find(a => a.id === accountId);
                    if (account) {
                        const newBalance = (parseFloat(account.balance) || 0) - amount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(accountId).update({
                                balance: newBalance
                            });
                    }
                } else if (type === 'transfer') {
                    // Transfer: Reverse both account changes
                    const fromAccount = accounts.find(a => a.id === accountId);
                    const toAccount = accounts.find(a => a.id === toAccountId);
                    
                    if (fromAccount) {
                        const newBalance = (parseFloat(fromAccount.balance) || 0) + amount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(accountId).update({
                                balance: newBalance
                            });
                    }
                    
                    if (toAccount) {
                        const newBalance = (parseFloat(toAccount.balance) || 0) - amount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(toAccountId).update({
                                balance: newBalance
                            });
                    }
                }

                console.log('‚úÖ Transaction deleted successfully');

                // Reload data and update UI
                await loadAllData();
                renderAccounts();
                renderCategories();
                renderTransactions();
                updateOverview();

            } catch (error) {
                console.error('‚ùå Error deleting transaction:', error);
                alert('Failed to delete transaction: ' + error.message);
            }
        }

        // ============================================
        // EDIT TRANSACTION
        // ============================================
        function editTransaction(transaction) {
            // Store original values for balance calculation
            document.getElementById('editTransactionId').value = transaction.id;
            document.getElementById('editTransactionType').value = transaction.type;
            document.getElementById('editOriginalAmount').value = transaction.amount;
            document.getElementById('editOriginalAccountId').value = transaction.accountId;
            document.getElementById('editOriginalToAccountId').value = transaction.toAccountId || '';

            // Populate account dropdowns
            const accountSelects = ['editAccount', 'editFromAccount', 'editToAccount'];
            accountSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select account...</option>';
                accounts.forEach(acc => {
                    select.innerHTML += `<option value="${acc.id}">${escapeHtml(acc.name)}</option>`;
                });
            });

            // Populate category dropdown
            const categorySelect = document.getElementById('editCategory');
            categorySelect.innerHTML = '<option value="">Select category...</option>';
            categories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`;
            });

            const txDate = transaction.date?.toDate ? transaction.date.toDate() : new Date(transaction.date);
            const dateString = txDate.toISOString().split('T')[0];

            if (transaction.type === 'transfer') {
                // Show transfer fields
                document.getElementById('editStandardFields').style.display = 'none';
                document.getElementById('editTransferFields').style.display = 'block';
                document.getElementById('editModalHeader').textContent = 'Edit Transfer';

                document.getElementById('editTransferAmount').value = transaction.amount;
                document.getElementById('editFromAccount').value = transaction.accountId;
                document.getElementById('editToAccount').value = transaction.toAccountId || '';
                document.getElementById('editTransferDate').value = dateString;
                document.getElementById('editTransferNote').value = transaction.note || '';
            } else {
                // Show standard fields
                document.getElementById('editStandardFields').style.display = 'block';
                document.getElementById('editTransferFields').style.display = 'none';

                if (transaction.type === 'payment') {
                    document.getElementById('editModalHeader').textContent = 'Edit Payment';
                    document.getElementById('editCategoryGroup').style.display = 'block';
                } else if (transaction.type === 'salary') {
                    document.getElementById('editModalHeader').textContent = 'Edit Salary';
                    document.getElementById('editCategoryGroup').style.display = 'none';
                } else if (transaction.type === 'deposit') {
                    document.getElementById('editModalHeader').textContent = 'Edit Deposit';
                    document.getElementById('editCategoryGroup').style.display = 'block';
                }

                document.getElementById('editAmount').value = transaction.amount;
                document.getElementById('editAccount').value = transaction.accountId;
                document.getElementById('editCategory').value = transaction.categoryId || '';
                document.getElementById('editDate').value = dateString;
                document.getElementById('editNote').value = transaction.note || '';
            }

            openModal('editTransactionModal');
        }

        async function saveEditedTransaction(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('You must be logged in');
                return;
            }

            const transactionId = document.getElementById('editTransactionId').value;
            const type = document.getElementById('editTransactionType').value;
            const originalAmount = parseFloat(document.getElementById('editOriginalAmount').value);
            const originalAccountId = document.getElementById('editOriginalAccountId').value;
            const originalToAccountId = document.getElementById('editOriginalToAccountId').value;

            try {
                let newAmount, newAccountId, newToAccountId, newCategoryId, newDate, newNote;

                if (type === 'transfer') {
                    newAmount = parseFloat(document.getElementById('editTransferAmount').value);
                    newAccountId = document.getElementById('editFromAccount').value;
                    newToAccountId = document.getElementById('editToAccount').value;
                    newDate = document.getElementById('editTransferDate').value;
                    newNote = document.getElementById('editTransferNote').value.trim();
                    newCategoryId = null;
                } else {
                    newAmount = parseFloat(document.getElementById('editAmount').value);
                    newAccountId = document.getElementById('editAccount').value;
                    newCategoryId = document.getElementById('editCategory').value || null;
                    newDate = document.getElementById('editDate').value;
                    newNote = document.getElementById('editNote').value.trim();
                    newToAccountId = null;
                }

                // Validation
                if (!newAmount || newAmount <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }

                // Step 1: Reverse original transaction's effect on balances
                if (type === 'payment') {
                    const account = accounts.find(a => a.id === originalAccountId);
                    if (account) {
                        const balance = (parseFloat(account.balance) || 0) + originalAmount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(originalAccountId).update({ balance });
                    }
                } else if (type === 'deposit' || type === 'salary') {
                    const account = accounts.find(a => a.id === originalAccountId);
                    if (account) {
                        const balance = (parseFloat(account.balance) || 0) - originalAmount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(originalAccountId).update({ balance });
                    }
                } else if (type === 'transfer') {
                    const fromAccount = accounts.find(a => a.id === originalAccountId);
                    const toAccount = accounts.find(a => a.id === originalToAccountId);
                    if (fromAccount) {
                        const balance = (parseFloat(fromAccount.balance) || 0) + originalAmount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(originalAccountId).update({ balance });
                    }
                    if (toAccount) {
                        const balance = (parseFloat(toAccount.balance) || 0) - originalAmount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(originalToAccountId).update({ balance });
                    }
                }

                // Step 2: Update transaction in Firestore
                await db.collection('users').doc(currentUser.uid)
                    .collection('transactions').doc(transactionId).update({
                        amount: newAmount,
                        accountId: newAccountId,
                        toAccountId: newToAccountId,
                        categoryId: newCategoryId,
                        date: firebase.firestore.Timestamp.fromDate(new Date(newDate)),
                        note: newNote
                    });

                // Step 3: Apply new transaction's effect on balances
                if (type === 'payment') {
                    const account = accounts.find(a => a.id === newAccountId);
                    if (account) {
                        const balance = (parseFloat(account.balance) || 0) - newAmount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(newAccountId).update({ balance });
                    }
                } else if (type === 'deposit' || type === 'salary') {
                    const account = accounts.find(a => a.id === newAccountId);
                    if (account) {
                        const balance = (parseFloat(account.balance) || 0) + newAmount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(newAccountId).update({ balance });
                    }
                } else if (type === 'transfer') {
                    const fromAccount = accounts.find(a => a.id === newAccountId);
                    const toAccount = accounts.find(a => a.id === newToAccountId);
                    if (fromAccount) {
                        const balance = (parseFloat(fromAccount.balance) || 0) - newAmount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(newAccountId).update({ balance });
                    }
                    if (toAccount) {
                        const balance = (parseFloat(toAccount.balance) || 0) + newAmount;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('accounts').doc(newToAccountId).update({ balance });
                    }
                }

                console.log('‚úÖ Transaction updated successfully');

                // Close modal and reload
                closeModal('editTransactionModal');
                await loadAllData();
                renderAccounts();
                renderCategories();
                renderTransactions();
                updateOverview();

            } catch (error) {
                console.error('‚ùå Error updating transaction:', error);
                alert('Failed to update transaction: ' + error.message);
            }
        }

        // ============================================
        // RENDER TRANSACTIONS
        // ============================================
        function renderTransactions() {
            const container = document.getElementById('transactionsContainer');
            let header = document.querySelector('.transactions-header');
            
            // Create header if it doesn't exist
            if (!header) {
                header = document.createElement('div');
                header.className = 'transactions-header';
                container.parentNode.insertBefore(header, container);
            }
            
            container.innerHTML = '';

            // Smart filtering based on selection
            let filteredTransactions;
            if (selectedAccountId === null) {
                // All Accounts view: Show only budget-relevant transactions
                // (categorized payments only - excludes salary, transfers, uncategorized)
                filteredTransactions = transactions.filter(t => 
                    t.type === 'payment' && t.categoryId !== null
                );
                header.textContent = 'Recent Transactions - Budget Overview';
            } else {
                // Specific account view: Show ALL transactions for that account
                filteredTransactions = transactions.filter(t => 
                    t.accountId === selectedAccountId
                );
                const account = accounts.find(a => a.id === selectedAccountId);
                header.textContent = `Recent Transactions - ${account?.name || 'Account'}`;
            }

            if (filteredTransactions.length === 0) {
                container.innerHTML = '<div class="loading">No transactions yet</div>';
                return;
            }

            // Sort transactions by date (newest first)
            const sortedTransactions = [...filteredTransactions].sort((a, b) => {
                const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date);
                const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date);
                return dateB - dateA;
            });

            // Show last 10 transactions
            const recentTransactions = sortedTransactions.slice(0, 10);

            recentTransactions.forEach(tx => {
                const account = accounts.find(a => a.id === tx.accountId);
                const category = categories.find(c => c.id === tx.categoryId);
                
                let icon, amountClass, description;
                
                if (tx.type === 'salary') {
                    icon = 'üí∞';
                    amountClass = 'income';
                    description = tx.note || 'Salary';
                } else if (tx.type === 'payment') {
                    icon = 'üí∏';
                    amountClass = 'expense';
                    description = tx.note || 'Payment';
                } else if (tx.type === 'deposit') {
                    icon = 'üí∞';
                    amountClass = 'income';
                    description = tx.note || 'Deposit';
                } else if (tx.type === 'transfer') {
                    icon = 'üîÑ';
                    amountClass = '';
                    const toAccount = accounts.find(a => a.id === tx.toAccountId);
                    description = tx.note || `Transfer to ${toAccount?.name || 'Unknown'}`;
                }

                const txDate = tx.date?.toDate ? tx.date.toDate() : new Date(tx.date);
                const formattedDate = txDate.toLocaleDateString('en-GB', { 
                    day: '2-digit', 
                    month: 'short' 
                });

                const div = document.createElement('div');
                div.className = 'transaction-item';
                div.onclick = () => editTransaction(tx); // Click to edit
                div.innerHTML = `
                    <div class="transaction-icon">${icon}</div>
                    <div class="transaction-description">${escapeHtml(description)}</div>
                    <div class="transaction-category">${category?.name || '‚Äî'}</div>
                    <div class="transaction-amount ${amountClass}">
                        ${tx.type === 'payment' ? '-' : (tx.type === 'deposit' || tx.type === 'salary') ? '+' : ''}${formatCurrency(tx.amount)}
                    </div>
                    <div class="transaction-date">${formattedDate}</div>
                    <div class="transaction-account">${account?.name || 'Unknown'}</div>
                    <div class="transaction-delete" onclick="event.stopPropagation(); deleteTransaction('${tx.id}', '${tx.type}', ${tx.amount}, '${tx.accountId}', '${tx.toAccountId || ''}')">√ó</div>
                `;
                container.appendChild(div);
            });
        }

        // ============================================
        // RECURRING TRANSACTIONS
        // ============================================
        let recurringTransactions = [];

        async function loadRecurringTransactions() {
            if (!currentUser) return;

            try {
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('recurringTransactions')
                    .get();

                recurringTransactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                renderRecurringTransactions();
                console.log('‚úÖ Recurring transactions loaded:', recurringTransactions.length);

            } catch (error) {
                console.error('‚ùå Error loading recurring transactions:', error);
            }
        }

        function renderRecurringTransactions() {
            const container = document.getElementById('recurringBillsContainer');
            
            if (recurringTransactions.length === 0) {
                container.innerHTML = '<div class="loading">No recurring bills yet</div>';
                return;
            }

            container.innerHTML = '';
            const billsList = document.createElement('div');
            billsList.className = 'recurring-bills-list';

            recurringTransactions.forEach(bill => {
                const nextDue = bill.nextDueDate?.toDate ? bill.nextDueDate.toDate() : null;
                const nextDueStr = nextDue ? nextDue.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                }) : 'Not set';

                const div = document.createElement('div');
                div.className = 'recurring-bill-item';
                div.innerHTML = `
                    <div class="recurring-bill-info">
                        <div class="recurring-bill-name">${escapeHtml(bill.name || 'Bill')}</div>
                        <div class="recurring-bill-meta">
                            <span class="frequency-badge">${bill.frequency || 'monthly'}</span>
                            <span>${escapeHtml(bill.category || 'Uncategorized')}</span>
                        </div>
                    </div>
                    <div class="recurring-bill-amount">${formatCurrency(Math.abs(bill.amount || 0))}</div>
                    <div class="recurring-bill-due">Due: ${nextDueStr}</div>
                    <div class="recurring-bill-actions">
                        <button class="bill-action-btn edit-btn">Edit</button>
                        <button class="bill-action-btn delete delete-btn">Delete</button>
                    </div>
                `;
                
                // Add event listeners safely
                const editBtn = div.querySelector('.edit-btn');
                const deleteBtn = div.querySelector('.delete-btn');
                editBtn.addEventListener('click', () => editRecurringTransaction(bill.id));
                deleteBtn.addEventListener('click', () => deleteRecurringTransaction(bill.id));
                
                billsList.appendChild(div);
            });

            container.appendChild(billsList);
        }

        function updateRecurringDateFields() {
            const frequency = document.getElementById('recurringFrequency').value;
            const dayOfMonthGroup = document.getElementById('dayOfMonthGroup');
            const dayOfWeekGroup = document.getElementById('dayOfWeekGroup');

            if (frequency === 'weekly' || frequency === 'biweekly') {
                dayOfMonthGroup.style.display = 'none';
                dayOfWeekGroup.style.display = 'block';
            } else {
                dayOfMonthGroup.style.display = 'block';
                dayOfWeekGroup.style.display = 'none';
            }
        }

        function updateEditRecurringDateFields() {
            const frequency = document.getElementById('editRecurringFrequency').value;
            const dayOfMonthGroup = document.getElementById('editDayOfMonthGroup');
            const dayOfWeekGroup = document.getElementById('editDayOfWeekGroup');

            if (frequency === 'weekly' || frequency === 'biweekly') {
                dayOfMonthGroup.style.display = 'none';
                dayOfWeekGroup.style.display = 'block';
            } else {
                dayOfMonthGroup.style.display = 'block';
                dayOfWeekGroup.style.display = 'none';
            }
        }

        async function saveRecurringTransaction(event) {
            event.preventDefault();
            if (!currentUser) return;

            try {
                const name = document.getElementById('recurringName').value;
                const amount = parseFloat(document.getElementById('recurringAmount').value);
                const category = document.getElementById('recurringCategory').value;
                const frequency = document.getElementById('recurringFrequency').value;
                const nextDueDateStr = document.getElementById('recurringNextDue').value;
                
                let dayOfMonth = null;
                let dayOfWeek = null;

                if (frequency === 'weekly' || frequency === 'biweekly') {
                    dayOfWeek = parseInt(document.getElementById('recurringDayOfWeek').value);
                } else {
                    dayOfMonth = parseInt(document.getElementById('recurringDayOfMonth').value);
                }

                const nextDueDate = new Date(nextDueDateStr);

                const recurringData = {
                    name: name,
                    amount: amount,
                    category: category,
                    frequency: frequency,
                    nextDueDate: firebase.firestore.Timestamp.fromDate(nextDueDate),
                    dayOfMonth: dayOfMonth,
                    dayOfWeek: dayOfWeek,
                    isActive: true,
                    autoCreate: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('recurringTransactions')
                    .add(recurringData);

                console.log('‚úÖ Recurring transaction added');
                
                // Reset form and close modal
                document.getElementById('recurringName').value = '';
                document.getElementById('recurringAmount').value = '';
                document.getElementById('recurringCategory').value = '';
                document.getElementById('recurringNextDue').value = '';
                closeModal('addRecurringModal');

                // Reload data
                await loadRecurringTransactions();

            } catch (error) {
                console.error('‚ùå Error saving recurring transaction:', error);
                alert('Failed to add recurring bill: ' + error.message);
            }
        }

        function editRecurringTransaction(billId) {
            const bill = recurringTransactions.find(b => b.id === billId);
            if (!bill) return;

            // Populate form fields
            document.getElementById('editRecurringId').value = bill.id;
            document.getElementById('editRecurringName').value = bill.name || '';
            document.getElementById('editRecurringAmount').value = Math.abs(bill.amount || 0);
            document.getElementById('editRecurringCategory').value = bill.category || '';
            document.getElementById('editRecurringFrequency').value = bill.frequency || 'monthly';
            document.getElementById('editRecurringIsActive').checked = bill.isActive !== false;

            // Set day of month or week
            if (bill.dayOfMonth !== null && bill.dayOfMonth !== undefined) {
                document.getElementById('editRecurringDayOfMonth').value = bill.dayOfMonth;
            }
            if (bill.dayOfWeek !== null && bill.dayOfWeek !== undefined) {
                document.getElementById('editRecurringDayOfWeek').value = bill.dayOfWeek;
            }

            // Set next due date
            if (bill.nextDueDate?.toDate) {
                const nextDue = bill.nextDueDate.toDate();
                const dateStr = nextDue.toISOString().split('T')[0];
                document.getElementById('editRecurringNextDue').value = dateStr;
            }

            // Populate category dropdown
            const categorySelect = document.getElementById('editRecurringCategory');
            categorySelect.innerHTML = '<option value="">Select category...</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
            categorySelect.value = bill.category || '';

            // Update visibility of date fields
            updateEditRecurringDateFields();

            // Open modal
            openModal('editRecurringModal');
        }

        async function updateRecurringTransaction(event) {
            event.preventDefault();
            if (!currentUser) return;

            try {
                const billId = document.getElementById('editRecurringId').value;
                const name = document.getElementById('editRecurringName').value;
                const amount = parseFloat(document.getElementById('editRecurringAmount').value);
                const category = document.getElementById('editRecurringCategory').value;
                const frequency = document.getElementById('editRecurringFrequency').value;
                const nextDueDateStr = document.getElementById('editRecurringNextDue').value;
                const isActive = document.getElementById('editRecurringIsActive').checked;
                
                let dayOfMonth = null;
                let dayOfWeek = null;

                if (frequency === 'weekly' || frequency === 'biweekly') {
                    dayOfWeek = parseInt(document.getElementById('editRecurringDayOfWeek').value);
                } else {
                    dayOfMonth = parseInt(document.getElementById('editRecurringDayOfMonth').value);
                }

                const nextDueDate = new Date(nextDueDateStr);

                const updateData = {
                    name: name,
                    amount: amount,
                    category: category,
                    frequency: frequency,
                    nextDueDate: firebase.firestore.Timestamp.fromDate(nextDueDate),
                    dayOfMonth: dayOfMonth,
                    dayOfWeek: dayOfWeek,
                    isActive: isActive,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('recurringTransactions')
                    .doc(billId)
                    .update(updateData);

                console.log('‚úÖ Recurring transaction updated');
                
                closeModal('editRecurringModal');
                await loadRecurringTransactions();

            } catch (error) {
                console.error('‚ùå Error updating recurring transaction:', error);
                alert('Failed to update recurring bill: ' + error.message);
            }
        }

        async function deleteRecurringTransaction(billId) {
            if (!confirm('Are you sure you want to delete this recurring bill?')) return;
            if (!currentUser) return;

            try {
                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('recurringTransactions')
                    .doc(billId)
                    .delete();

                console.log('‚úÖ Recurring transaction deleted');
                await loadRecurringTransactions();

            } catch (error) {
                console.error('‚ùå Error deleting recurring transaction:', error);
                alert('Failed to delete recurring bill: ' + error.message);
            }
        }
    </script>
</body>
</html>