<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget - CrewWealth</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --color-primary: #208089;
            --color-primary-hover: #1a6670;
            --color-primary-active: #1a5460;
            --color-secondary: #5e5240;
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-border: #e8e8e0;
            --color-success: #22c55e;
            --color-warning: #f59e61;
            --color-danger: #ef4444;
            --color-accent: #32b8c6;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        .accounts-sidebar {
            width: 220px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            color: var(--color-text);
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
            display: block;
        }

        .sidebar-title:hover {
            color: var(--color-primary);
        }

        .account-section {
            margin-bottom: var(--spacing-xl);
        }

        .account-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-secondary);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .account-item:hover {
            background: rgba(32, 128, 137, 0.08);
        }

        .account-item.active {
            background: var(--color-primary);
            color: white;
        }

        .account-name {
            font-weight: 500;
            flex: 1;
        }

        .account-balance {
            font-weight: 600;
            font-size: 12px;
        }

        .account-delete {
            margin-left: var(--spacing-sm);
            color: var(--color-danger);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
        }

        .account-item:hover .account-delete {
            opacity: 1;
        }

        .add-account-btn {
            width: 100%;
            padding: var(--spacing-sm);
            background: transparent;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-account-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--spacing-lg) var(--spacing-2xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .back-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(32, 128, 137, 0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: rgba(32, 128, 137, 0.2);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .month-btn {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .month-btn:hover {
            background: rgba(32, 128, 137, 0.1);
        }

        .current-month {
            font-size: 16px;
            font-weight: 600;
            min-width: 150px;
            text-align: center;
        }

        .budget-overview {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: white;
            padding: var(--spacing-xl) var(--spacing-2xl);
            margin: var(--spacing-xl) var(--spacing-2xl) 0;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .overview-item {
            text-align: center;
        }

        .overview-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: var(--spacing-xs);
        }

        .overview-value {
            font-size: 20px;
            font-weight: 700;
        }

        .to-budget {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .to-budget-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: var(--spacing-xs);
        }

        .to-budget-value {
            font-size: 36px;
            font-weight: 700;
        }

        .categories-section {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-xl) var(--spacing-2xl);
        }

        .category-group {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }

        .category-group-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(32, 128, 137, 0.05);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .category-group-header:hover {
            background: rgba(32, 128, 137, 0.08);
        }

        .category-group-name {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text);
        }

        .category-group-totals {
            display: flex;
            gap: var(--spacing-xl);
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .category-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 40px;
            gap: var(--spacing-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--color-border);
            align-items: center;
        }

        .category-row:hover {
            background: rgba(32, 128, 137, 0.03);
        }

        .category-name {
            font-size: 14px;
            font-weight: 500;
        }

        .category-value {
            font-size: 14px;
            font-weight: 600;
            text-align: right;
        }

        .category-value.positive {
            color: var(--color-success);
        }

        .category-value.negative {
            color: var(--color-danger);
        }

        .budget-input {
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            text-align: right;
            font-weight: 600;
            background: var(--color-surface);
            width: 100%;
        }

        .budget-input:focus {
            outline: none;
            border-color: var(--color-primary);
            background: rgba(32, 128, 137, 0.05);
        }

        .category-delete {
            color: var(--color-danger);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
            text-align: center;
        }

        .category-row:hover .category-delete {
            opacity: 1;
        }

        .add-category-btn {
            width: 100%;
            padding: var(--spacing-md);
            background: transparent;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            font-size: 13px;
            cursor: pointer;
            margin-bottom: var(--spacing-lg);
            transition: all 0.2s;
        }

        .add-category-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text);
        }

        .form-input, .form-select {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .btn {
            flex: 1;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: rgba(94, 82, 64, 0.1);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.2);
        }

        @media (max-width: 1024px) {
            .accounts-sidebar {
                display: none;
            }
            
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .category-row {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .category-value {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="accounts-sidebar">
            <a href="/" class="sidebar-title">üí∞ CrewWealth</a>

            <div class="account-section">
                <div class="account-section-header">
                    <span>All accounts</span>
                    <span id="allAccountsTotal">‚Ç¨0.00</span>
                </div>
            </div>

            <div class="account-section">
                <div class="account-section-header">
                    <span>On budget</span>
                    <span id="onBudgetTotal">‚Ç¨0.00</span>
                </div>
                <div id="onBudgetAccounts"></div>
            </div>

            <div class="account-section">
                <div class="account-section-header">
                    <span>Off budget</span>
                    <span id="offBudgetTotal">‚Ç¨0.00</span>
                </div>
                <div id="offBudgetAccounts"></div>
            </div>

            <button class="add-account-btn" onclick="openAddAccountModal()">+ Add account</button>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <a href="/" class="back-btn">‚Üê Dashboard</a>
                    <h1 class="page-title">Budget</h1>
                </div>
                <div class="month-selector">
                    <button class="month-btn" onclick="changeMonth(-1)">‚óÄ</button>
                    <div class="current-month" id="currentMonth">January 2026</div>
                    <button class="month-btn" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
            </div>

            <div class="budget-overview">
                <div class="overview-grid">
                    <div class="overview-item">
                        <div class="overview-label">Available funds</div>
                        <div class="overview-value" id="availableFunds">‚Ç¨0.00</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Overspent</div>
                        <div class="overview-value" id="overspent">‚Ç¨0.00</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Budgeted</div>
                        <div class="overview-value" id="budgeted">‚Ç¨0.00</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-label">Total spent</div>
                        <div class="overview-value" id="totalSpent">‚Ç¨0.00</div>
                    </div>
                </div>
                <div class="to-budget">
                    <div class="to-budget-label">To Budget</div>
                    <div class="to-budget-value" id="toBudget">‚Ç¨0.00</div>
                </div>
            </div>

            <div class="categories-section">
                <div id="categoriesContainer"></div>
                <button class="add-category-btn" onclick="openAddCategoryModal()">+ Add category</button>
            </div>
        </main>
    </div>

    <!-- ADD ACCOUNT MODAL -->
    <div class="modal" id="addAccountModal">
        <div class="modal-content">
            <div class="modal-header">Add Account</div>
            <form onsubmit="saveAccount(event)">
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" id="accountName" placeholder="e.g., Checking Account" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Starting Balance (‚Ç¨)</label>
                    <input type="number" class="form-input" id="accountBalance" step="0.01" value="0.00" required>
                </div>
                <div class="form-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="accountOffBudget">
                        <span>Off Budget (Investments/Savings)</span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addAccountModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD CATEGORY MODAL -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">Add Category</div>
            <form onsubmit="saveCategory(event)">
                <div class="form-group">
                    <label class="form-label">Category Group</label>
                    <select class="form-select" id="categoryGroup" required>
                        <option value="expenses">üí∏ Daily Expenses</option>
                        <option value="savings">üí∞ Savings Goals</option>
                        <option value="bills">üìÑ Monthly Bills</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category Name</label>
                    <input type="text" class="form-input" id="categoryName" placeholder="e.g., Groceries" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCategoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD TRANSACTION MODAL -->
    <div class="modal" id="addTransactionModal">
        <div class="modal-content">
            <div class="modal-header">Add Transaction</div>
            <form onsubmit="saveTransaction(event)">
                <div class="form-group">
                    <label class="form-label">Transaction Type</label>
                    <select class="form-select" id="transactionType" onchange="updateTransactionFields()" required>
                        <option value="">Select type...</option>
                        <option value="budget">üìä Budget (Assign money to category)</option>
                        <option value="transfer">üí∏ Transfer (Move between accounts)</option>
                        <option value="income">üí∞ Income (Add money)</option>
                    </select>
                </div>

                <div class="form-group" id="categoryField" style="display:none;">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="transactionCategory">
                        <option value="">Select category...</option>
                    </select>
                </div>

                <div class="form-group" id="accountField" style="display:none;">
                    <label class="form-label">To Account</label>
                    <select class="form-select" id="transactionToAccount">
                        <option value="">Select account...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Amount (‚Ç¨)</label>
                    <input type="number" class="form-input" id="transactionAmount" step="0.01" min="0" placeholder="Enter amount" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Memo (optional)</label>
                    <input type="text" class="form-input" id="transactionMemo" placeholder="Optional note">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTransactionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBJws39S0tr3SiFV15Ij8Za1VvVKihWetI",
            authDomain: "crewwealth-cbe02.firebaseapp.com",
            projectId: "crewwealth-cbe02",
            storageBucket: "crewwealth-cbe02.firebasestorage.app",
            messagingSenderId: "522907048863",
            appId: "1:522907048863:web:d0b4b6ea4f1f8a7f3e8e8e"
        };

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let accounts = [];
let categories = [];
let budgets = {};
let transactions = [];
let currentDate = new Date();
let currentUser = null;
let authInitialized = false;

// Set auth persistence
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .then(() => console.log('‚úÖ Auth persistence set'))
    .catch(err => console.error('‚ùå Persistence error:', err));

// üîê AUTH CHECK - ONLY ONE TIME!
auth.onAuthStateChanged(async (user) => {
    console.log('üîê Auth state changed:', user ? user.email : 'No user');
    
    if (authInitialized) {
        console.log('‚ö†Ô∏è Auth already initialized, skipping...');
        return;
    }
    
    if (!user) {
        console.log('‚è≥ No user detected, waiting 2s...');
        setTimeout(() => {
            if (!auth.currentUser) {
                console.log('‚ùå Still no user. Redirecting to login...');
                window.location.href = '/login';
            } else {
                console.log('‚úÖ User loaded after delay');
                currentUser = auth.currentUser;
                authInitialized = true;
                init();
            }
        }, 2000);
        return;
    }
    
    console.log('‚úÖ User logged in:', user.uid);
    currentUser = user;
    authInitialized = true;
    await init();
});
        async function init() {
            updateMonthDisplay();
            await loadData();
            renderAccounts();
            renderCategories();
            updateOverview();
        }

        async function loadData() {
            const user = auth.currentUser;
            if (!user) {
                console.error('‚ùå No user in loadData');
                return;
            }

            try {
                console.log('üîç Loading data for user:', user.uid);
                
                const accountsSnapshot = await db.collection('users').doc(user.uid)
                    .collection('accounts').get();
                accounts = accountsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const categoriesSnapshot = await db.collection('users').doc(user.uid)
                    .collection('categories').get();
                categories = categoriesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const monthKey = getMonthKey();
                const budgetDoc = await db.collection('users').doc(user.uid)
                    .collection('budgets').doc(monthKey).get();
                budgets = budgetDoc.exists ? { [monthKey]: budgetDoc.data() } : { [monthKey]: {} };

                const transactionsSnapshot = await db.collection('users').doc(user.uid)
                    .collection('transactions').get();
                transactions = transactionsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log('‚úÖ Data loaded:', { 
                    accounts: accounts.length, 
                    categories: categories.length, 
                    transactions: transactions.length 
                });
            } catch (error) {
                console.error('‚ùå Error loading ', error);
                alert('Failed to load  ' + error.message);
            }
        }


        function getMonthKey() {
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        function updateMonthDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[currentDate.getMonth()];
            const year = currentDate.getFullYear();
            document.getElementById('currentMonth').textContent = `${monthName} ${year}`;
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            updateMonthDisplay();
            loadData().then(() => {
                renderCategories();
                updateOverview();
            });
        }

        function renderAccounts() {
            const onBudgetContainer = document.getElementById('onBudgetAccounts');
            const offBudgetContainer = document.getElementById('offBudgetAccounts');

            onBudgetContainer.innerHTML = '';
            offBudgetContainer.innerHTML = '';

            let allTotal = 0;
            let onBudgetTotal = 0;
            let offBudgetTotal = 0;

            accounts.forEach(account => {
                const div = document.createElement('div');
                div.className = 'account-item';
                div.innerHTML = `
                    <span class="account-name">${account.name}</span>
                    <span class="account-balance">‚Ç¨${account.balance.toFixed(2)}</span>
                    <span class="account-delete" onclick="deleteAccount('${account.id}')">√ó</span>
                `;

                if (account.offBudget) {
                    offBudgetContainer.appendChild(div);
                    offBudgetTotal += account.balance;
                } else {
                    onBudgetContainer.appendChild(div);
                    onBudgetTotal += account.balance;
                }

                allTotal += account.balance;
            });

            document.getElementById('allAccountsTotal').textContent = `‚Ç¨${allTotal.toFixed(2)}`;
            document.getElementById('onBudgetTotal').textContent = `‚Ç¨${onBudgetTotal.toFixed(2)}`;
            document.getElementById('offBudgetTotal').textContent = `‚Ç¨${offBudgetTotal.toFixed(2)}`;
        }

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            const monthKey = getMonthKey();
            const currentBudgets = budgets[monthKey] || {};

            const groups = {
                expenses: { name: 'üí∏ Daily Expenses', categories: [] },
                savings: { name: 'üí∞ Savings Goals', categories: [] },
                bills: { name: 'üìÑ Monthly Bills', categories: [] }
            };

            categories.forEach(cat => {
                if (groups[cat.group]) {
                    groups[cat.group].categories.push(cat);
                }
            });

            Object.entries(groups).forEach(([groupKey, group]) => {
                if (group.categories.length === 0) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'category-group';

                let groupBudgeted = 0;
                let groupSpent = 0;

                group.categories.forEach(cat => {
                    const budgeted = currentBudgets[cat.id] || 0;
                    const spent = calculateSpent(cat.id, monthKey);
                    groupBudgeted += budgeted;
                    groupSpent += spent;
                });

                const groupAvailable = groupBudgeted - groupSpent;

                groupDiv.innerHTML = `
                    <div class="category-group-header">
                        <span class="category-group-name">${group.name}</span>
                        <div class="category-group-totals">
                            <span>Budgeted: ‚Ç¨${groupBudgeted.toFixed(2)}</span>
                            <span>Spent: ‚Ç¨${groupSpent.toFixed(2)}</span>
                            <span>Available: ‚Ç¨${groupAvailable.toFixed(2)}</span>
                        </div>
                    </div>
                `;

                group.categories.forEach(cat => {
                    const budgeted = currentBudgets[cat.id] || 0;
                    const spent = calculateSpent(cat.id, monthKey);
                    const available = budgeted - spent;

                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'category-row';
                    rowDiv.innerHTML = `
                        <div class="category-name">${cat.name}</div>
                        <div>
                            <input type="number" 
                                   class="budget-input" 
                                   value="${budgeted.toFixed(2)}" 
                                   step="0.01"
                                   onchange="updateBudget('${cat.id}', this.value)">
                        </div>
                        <div class="category-value">‚Ç¨${spent.toFixed(2)}</div>
                        <div class="category-value ${available >= 0 ? 'positive' : 'negative'}">
                            ‚Ç¨${available.toFixed(2)}
                        </div>
                        <div class="category-delete" onclick="deleteCategory('${cat.id}')">√ó</div>
                    `;
                    groupDiv.appendChild(rowDiv);
                });

                container.appendChild(groupDiv);
            });
        }

        function calculateSpent(categoryId, monthKey) {
            return transactions
                .filter(t => t.categoryId === categoryId && t.monthKey === monthKey && t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
        }

        function updateOverview() {
            const monthKey = getMonthKey();
            const currentBudgets = budgets[monthKey] || {};

            const onBudgetAccounts = accounts.filter(a => !a.offBudget);
            const availableFunds = onBudgetAccounts.reduce((sum, a) => sum + a.balance, 0);

            const totalBudgeted = Object.values(currentBudgets).reduce((sum, val) => sum + val, 0);
            const totalSpent = categories.reduce((sum, cat) => sum + calculateSpent(cat.id, monthKey), 0);
            const toBudget = availableFunds - totalBudgeted;

            const overspent = categories.reduce((sum, cat) => {
                const budgeted = currentBudgets[cat.id] || 0;
                const spent = calculateSpent(cat.id, monthKey);
                const diff = spent - budgeted;
                return sum + (diff > 0 ? diff : 0);
            }, 0);

            document.getElementById('availableFunds').textContent = `‚Ç¨${availableFunds.toFixed(2)}`;
            document.getElementById('overspent').textContent = `‚Ç¨${overspent.toFixed(2)}`;
            document.getElementById('budgeted').textContent = `‚Ç¨${totalBudgeted.toFixed(2)}`;
            document.getElementById('totalSpent').textContent = `‚Ç¨${totalSpent.toFixed(2)}`;
            document.getElementById('toBudget').textContent = `‚Ç¨${toBudget.toFixed(2)}`;
        }

        async function updateBudget(categoryId, value) {
            const user = auth.currentUser;
            if (!user) {
                alert('You must be logged in');
                return;
            }

            const monthKey = getMonthKey();
            if (!budgets[monthKey]) {
                budgets[monthKey] = {};
            }
            budgets[monthKey][categoryId] = parseFloat(value) || 0;

            try {
                await db.collection('users').doc(user.uid)
                    .collection('budgets').doc(monthKey).set(budgets[monthKey]);
                updateOverview();
                renderCategories();
            } catch (error) {
                console.error('Error updating budget:', error);
                alert('Failed to update budget: ' + error.message);
            }
        }


        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openAddAccountModal() {
            document.getElementById('accountName').value = '';
            document.getElementById('accountBalance').value = '0.00';
            document.getElementById('accountOffBudget').checked = false;
            openModal('addAccountModal');
        }

        function openAddCategoryModal() {
            document.getElementById('categoryGroup').value = 'expenses';
            document.getElementById('categoryName').value = '';
            openModal('addCategoryModal');
        }

        function openAddTransactionModal() {
            document.getElementById('transactionType').value = '';
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionMemo').value = '';
            updateTransactionFields();
            openModal('addTransactionModal');
        }

                async function saveAccount(event) {
            event.preventDefault();

            const user = auth.currentUser;
            if (!user) {
                alert('You must be logged in');
                return;
            }

            const name = document.getElementById('accountName').value;
            const balance = parseFloat(document.getElementById('accountBalance').value);
            const offBudget = document.getElementById('accountOffBudget').checked;

            try {
                await db.collection('users').doc(user.uid)
                    .collection('accounts').add({
                        name: name,
                        balance: balance,
                        offBudget: offBudget,
                        createdAt: new Date().toISOString()
                    });

                await loadData();
                renderAccounts();
                updateOverview();
                closeModal('addAccountModal');
                alert('Account added successfully!');
            } catch (error) {
                console.error('Error saving account:', error);
                alert('Failed to save account: ' + error.message);
            }
        }

        async function deleteAccount(accountId) {
            if (!confirm('Are you sure you want to delete this account?')) return;

            const user = auth.currentUser;
            if (!user) {
                alert('You must be logged in');
                return;
            }

            try {
                await db.collection('users').doc(user.uid)
                    .collection('accounts').doc(accountId).delete();

                await loadData();
                renderAccounts();
                updateOverview();
                alert('Account deleted successfully!');
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('Failed to delete account: ' + error.message);
            }
        }

        async function saveCategory(event) {
            event.preventDefault();

            const user = auth.currentUser;
            if (!user) {
                alert('You must be logged in');
                return;
            }

            const group = document.getElementById('categoryGroup').value;
            const name = document.getElementById('categoryName').value;

            try {
                await db.collection('users').doc(user.uid)
                    .collection('categories').add({
                        name: name,
                        group: group,
                        createdAt: new Date().toISOString()
                    });

                await loadData();
                renderCategories();
                closeModal('addCategoryModal');
                alert('Category added successfully!');
            } catch (error) {
                console.error('Error saving category:', error);
                alert('Failed to save category: ' + error.message);
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category?')) return;

            const user = auth.currentUser;
            if (!user) {
                alert('You must be logged in');
                return;
            }

            try {
                await db.collection('users').doc(user.uid)
                    .collection('categories').doc(categoryId).delete();

                await loadData();
                renderCategories();
                alert('Category deleted successfully!');
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('Failed to delete category: ' + error.message);
            }
        }

        function updateTransactionFields() {
            const type = document.getElementById('transactionType').value;
            const categoryField = document.getElementById('categoryField');
            const accountField = document.getElementById('accountField');

            categoryField.style.display = 'none';
            accountField.style.display = 'none';

            if (type === 'budget') {
                categoryField.style.display = 'block';
                populateCategoryDropdown();
            } else if (type === 'transfer') {
                accountField.style.display = 'block';
                populateAccountDropdown();
            }
        }

        function populateCategoryDropdown() {
            const select = document.getElementById('transactionCategory');
            select.innerHTML = '<option value="">Select category...</option>';

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }

        function populateAccountDropdown() {
            const select = document.getElementById('transactionToAccount');
            select.innerHTML = '<option value="">Select account...</option>';

            accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.name} (‚Ç¨${acc.balance.toFixed(2)})`;
                select.appendChild(option);
            });
        }

        async function saveTransaction(event) {
            event.preventDefault();

            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const memo = document.getElementById('transactionMemo').value;

            if (!type || !amount || amount <= 0) {
                alert('Please fill in all required fields with positive amounts');
                return;
            }

            try {
                const monthKey = getMonthKey();
                const transaction = {
                    type: type,
                    amount: amount,
                    memo: memo,
                    date: new Date().toISOString(),
                    monthKey: monthKey
                };

                if (type === 'budget') {
                    const categoryId = document.getElementById('transactionCategory').value;
                    if (!categoryId) {
                        alert('Please select a category');
                        return;
                    }

                    transaction.categoryId = categoryId;

                    if (!budgets[monthKey]) {
                        budgets[monthKey] = {};
                    }
                    budgets[monthKey][categoryId] = (budgets[monthKey][categoryId] || 0) + amount;

                    await db.collection('users').doc(currentUser.uid)
                        .collection('budgets').doc(monthKey).set(budgets[monthKey]);

                } else if (type === 'transfer') {
                    const toAccountId = document.getElementById('transactionToAccount').value;
                    if (!toAccountId) {
                        alert('Please select an account to transfer to');
                        return;
                    }

                    const fromAccount = accounts.find(a => !a.offBudget);
                    const toAccount = accounts.find(a => a.id === toAccountId);

                    if (!fromAccount || !toAccount) {
                        alert('Account not found');
                        return;
                    }

                    fromAccount.balance -= amount;
                    toAccount.balance += amount;

                    await db.collection('users').doc(currentUser.uid)
                        .collection('accounts').doc(fromAccount.id)
                        .update({ balance: fromAccount.balance });

                    await db.collection('users').doc(currentUser.uid)
                        .collection('accounts').doc(toAccount.id)
                        .update({ balance: toAccount.balance });

                    transaction.fromAccountId = fromAccount.id;
                    transaction.toAccountId = toAccountId;

                } else if (type === 'income') {
                    const budgetAccount = accounts.find(a => !a.offBudget);

                    if (!budgetAccount) {
                        alert('No budget account found');
                        return;
                    }

                    budgetAccount.balance += amount;

                    await db.collection('users').doc(currentUser.uid)
                        .collection('accounts').doc(budgetAccount.id)
                        .update({ balance: budgetAccount.balance });

                    transaction.accountId = budgetAccount.id;
                }

                await db.collection('users').doc(currentUser.uid)
                    .collection('transactions').add(transaction);

                await loadData();
                renderAccounts();
                renderCategories();
                updateOverview();

                closeModal('addTransactionModal');

                document.getElementById('transactionType').value = '';
                document.getElementById('transactionAmount').value = '';
                document.getElementById('transactionMemo').value = '';
                updateTransactionFields();

                alert('Transaction saved successfully!');

            } catch (error) {
                console.error('Error saving transaction:', error);
                alert('Failed to save transaction: ' + error.message);
            }
        }
    </script>
</body>
</html>
